

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/yuzhangnju/image2024/uchiha.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/yuzhangnju/image2024/uchiha.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Yu Zhang">
  <meta name="keywords" content="DID, 因果推断, 事件研究">
  
    <meta name="description" content="事件研究法的基本原理、代码实验与注意事项。">
<meta property="og:type" content="article">
<meta property="og:title" content="Handbook of Event Study">
<meta property="og:url" content="https://yuzhang.net/2023/11/11/Handbook%20of%20Event%20Study/index.html">
<meta property="og:site_name" content="Yu&#39;s Space">
<meta property="og:description" content="事件研究法的基本原理、代码实验与注意事项。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231106102506771.png">
<meta property="article:published_time" content="2023-11-11T02:00:00.000Z">
<meta property="article:modified_time" content="2023-11-15T07:18:07.444Z">
<meta property="article:author" content="Yu Zhang">
<meta property="article:tag" content="因果推断">
<meta property="article:tag" content="DID">
<meta property="article:tag" content="事件研究">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231106102506771.png">
  
  
  
  <title>Handbook of Event Study - Yu&#39;s Space</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yuzhang.net","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":100,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Yu&#39;s Space</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://cdn.jsdelivr.net/gh/yuzhangnju/image/img/bannernew.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Handbook of Event Study"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-11-11 10:00" pubdate>
          2023年11月11日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          112 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Handbook of Event Study</h1>
            
            
              <div class="markdown-body">
                
                <p>前文（<a target="_blank" rel="noopener" href="https://yuzhangnju.github.io/2023/10/25/Handbook%20of%20DID%20family_20231026/">Handbook of DID family</a>）提到，事件研究法现已成为DID策略的标准动作，用于<strong>检验平行趋势</strong>和发现<strong>外生冲击效应在时间上的变化</strong>，在此类应用中，事件研究法处于辅助地位。但DID设计本身存在两大缺陷，一是DID策略得到的是平均处理效应（ATE），而现实情况下我们更需要知道外生冲击在不同时段的不同影响，二是DID要求处理效应在冲击后立马显现，但事实上事件的效果往往需要过一段时间才能看出来（比如政策颁布的时点到执行层面落实有很长的间隔、疫苗接种后也不是立即生效）。（事实上DID策略还有很多其他问题，详见前文，在这些情况下，应用事件研究法可能是更好的选择。）</p>
<p>事件研究法为冲击的时间动态提供了丰富的细节（以图形直观展示），很好地弥补了DID的两大缺陷，在未来，事件研究法可能会与DID交换地位，成为处理效应研究的基准结果。</p>
<p>本篇博文摘录了事件研究法近期的进展，并在结尾附上代码，以<strong>在实践中学习</strong>为理念，我想通过实际操作，增进自己对事件研究法的掌握。</p>
<p>主要参考资料如下：</p>
<ul>
<li><p>张子尧 &amp; 黄炜.(2023).事件研究法的实现、问题和拓展. <em>数量经济技术经济研究</em>(09),71-92. </p>
</li>
<li><p>Miller, D. L. (2023). An Introductory Guide to Event Study Models. <em>Journal of Economic Perspectives</em>, <em>37</em>(2), 203-230.</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/5kC3RyyhZkOILtFrlbQOag">【香樟推文2919】ES，启动！——事件研究法入门指南</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/U-eJElBBzErXM5HaYl2mgA">【香樟推文2604】经久不衰的最低工资与就业问题——DID与事件研究法</a></p>
</li>
</ul>
<h2 id="1-事件研究法概述"><a href="#1-事件研究法概述" class="headerlink" title="1 事件研究法概述"></a>1 事件研究法概述</h2><h3 id="1-1-对事件研究法的直观理解"><a href="#1-1-对事件研究法的直观理解" class="headerlink" title="1.1 对事件研究法的直观理解"></a>1.1 对事件研究法的直观理解</h3><p>在<a target="_blank" rel="noopener" href="https://yuzhangnju.github.io/2023/10/25/Handbook%20of%20DID%20family_20231026/">前文</a>模拟数据进行平行趋势检验的代码中，可以发现，事件研究法与DID策略相比，两者回归方程的结构是一样的，但是主要变量由DID的“处理组*处理时点”换成了处理组虚拟变量与时间虚拟变量的所有可能性交互。直观理解就是，事件研究是将DID处理效应的箱子打开，将平均处理效应拆解为一系列“两组-两期”DID组合加权平均，有时事件研究法也被称为动态DID。（仔细想想是不是这样？事件研究法处理效应图中，每一个点都可以理解为一组 2x2 DID）</p>
<p><strong>一图胜千言：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231106154603637.png" srcset="/img/loading.gif" lazyload alt="image-20231106154603637"></p>
<p>⬆️上图展示了前文处理效应随时间变化的模拟数据结果，x轴为处理时点的相对时间，负数表示处理前，正数表示处理后，y轴是回归系数，及处理效应的大小和置信区间。</p>
<p>如果用DID的回归结果，我们能得到处理效应的大小，但是观测不到处理效应随时间的变化。使用事件研究法，我们可以发现在事前不存在处理效应，事后处理效应凸显，且效应的大小随时间增大。更丰富的处理效应，正是我们所关心的。</p>
<h3 id="1-2-结合方程与模拟数据的理解"><a href="#1-2-结合方程与模拟数据的理解" class="headerlink" title="1.2 结合方程与模拟数据的理解"></a>1.2 结合方程与模拟数据的理解</h3><p>来看看<a target="_blank" rel="noopener" href="https://www.lianxh.cn/details/826.html">估计方程</a>（不清楚为何公式1和2在网页渲染不成功，暂未找到解决方案，先用本地截图吧）：<br>$$<br>y_{st} &#x3D; \alpha + \sum_{j&#x3D;2}^J\beta_j(\text{Lag}\ j)<em>{st} + \sum</em>{k&#x3D;1}^K(\text{Lead}\ k)<em>{st} + \mu_s + \lambda_t + X’</em>{st}\Gamma + \epsilon_{st} \quad(1)<br>$$<br><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231112154728833.png" srcset="/img/loading.gif" lazyload alt="image-20231112154728833" style="zoom: 33%;" /></p>
<p>式（1），$y_{st}$ 是第 $s$ 个个体在第 $t$ 期的因变量，$J$ 和 $K$ 分别表示事前和事后的期数（也称为滞后项和前置项），$\mu_s$ 和 $\lambda_t$ 分别为个体固定效应与时间固定效应，我们要看的是前置项的系数。举个例子🌰：研究期为2008年到2017年，事件时点是2013年，那么 $J$ 就为4，$J$ 就为5。回归方程代码里，就要把这些年份都考虑进去。（写法很严谨，但见前文代码，操作很简单。）</p>
<p>用<a target="_blank" rel="noopener" href="https://www.aeaweb.org/articles?id=10.1257/jep.37.2.203">JEP论文</a>里的估计方程理解起来会更方便些（这个公式敲起来老费劲了）：<br>$$<br>y_{it} &#x3D;\underbrace{ (\sum_{j\in{-m,<em>\cdots,0,<em>\cdots,n} }\gamma_j\cdot D</em>{i,t-j} ) }</em>{\mathrm{Event\ Study\ Terms} }\  + \underbrace{\alpha_i+\delta_t}<em>{\mathrm{Panel\ Fixed\ Effects} } + \underbrace{\beta\cdot X</em>{it} }<em>{\mathrm{ (Optional)\ Control Variables} } + \epsilon</em>{it}\quad(2)<br>$$<br><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231112154811584.png" srcset="/img/loading.gif" lazyload alt="image-20231112154811584" style="zoom:33%;" /></p>
<p>式（2）中的重要系数含义如下：</p>
<ul>
<li>$\gamma_j$ : 事件系数，事后的系数能显示了事件处理的动态效果，事前的系数能提供安慰剂检验；</li>
<li>$D_{i,t-j}$ : 事件时间的指示变量。</li>
</ul>
<p> 再来看一个模拟数据的例子：</p>
<blockquote>
<p>模拟样本中共有 400 个个体，每个个体有 20 期观测值。样本中共包含 4 个组群(Group)，分别为 3 组在不同时点接受处理的处理组和 1 组未受处理的控制组，每组均包含 100 个个体。3 组处理组分别在第 5、10、15 期接受处理。处理组个体的处理效应随时间增长，受处理期限每增加 1 期处理效应随之增加 1 单位。（张子尧等，2023）</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/ES_ATT.png" srcset="/img/loading.gif" lazyload alt="ES_ATT"></p>
<p>试试看此时用DID，算出来的平均处理效应是多少？（实验见代码部分）</p>
<p>最早的相对处理期是-14期，最晚的相对处理组是15期，每个相对时期的平均处理效应如下（这应该算日历期的结果了？）：</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231106221142311.png" srcset="/img/loading.gif" lazyload alt="image-20231106221142311"></p>
<h3 id="1-3-事件研究法的基本假设"><a href="#1-3-事件研究法的基本假设" class="headerlink" title="1.3 事件研究法的基本假设"></a>1.3 事件研究法的基本假设</h3><p>指试用TWFE时，事件研究的对象应该满足的假设（即下图a、b的情况）：</p>
<ul>
<li>平行趋势假设</li>
<li>无预期效应假设</li>
<li>同质性处理效应路径假设</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231107203952473.png" srcset="/img/loading.gif" lazyload alt="image-20231107203952473"></p>
<h3 id="1-4-事件研究法的数据结构"><a href="#1-4-事件研究法的数据结构" class="headerlink" title="1.4 事件研究法的数据结构"></a>1.4 事件研究法的数据结构</h3><h2 id="2-事件研究法实践中的若干问题"><a href="#2-事件研究法实践中的若干问题" class="headerlink" title="2 事件研究法实践中的若干问题"></a>2 事件研究法实践中的若干问题</h2><h3 id="2-1-基期选择"><a href="#2-1-基期选择" class="headerlink" title="2.1 基期选择"></a>2.1 基期选择</h3><p>基期是选择一个参照组，作为其他期可比对象，这样才能判断处理效应是不是显著、大小如何。理论上，基期选在处理时点之前的任一期都可，如果在不手动选的话，Stata会默认drop掉最早的一期。</p>
<p>但在实践中，将-1期，即事件发生的前一期作为基期的情况比较普遍，考虑到可能存在预期效应，也可以选择-3期。选择-1期，是现在的标准动作。（选择其他期难免被人怀疑操纵数据或挑选结果）</p>
<h3 id="2-2-对事前平行趋势假设的检验"><a href="#2-2-对事前平行趋势假设的检验" class="headerlink" title="2.2 对事前平行趋势假设的检验"></a>2.2 对事前平行趋势假设的检验</h3><p>再强调一遍，平行趋势检验是非常重要的，它是使得潜在结果因果框架里处理组的反事实成立的最重要的条件。</p>
<p>当前的论文中，对平行趋势的检验，就是选择基准期后，观察事前每一期的系数是否为0，如果每一期的系数都不显著，就认为满足事前平行趋势。但这样做有两个问题：</p>
<ul>
<li>基期的影响很重要，选择不同的基期，系数的结果可能正好相反，基准期会整体上影响每一期系数的显著性；因此，有挑选结果的可能性；</li>
<li>事前平行趋势要求处理前每一期的平均处理效应为 0，其对应的原假设是 $\mu_{-2}&#x3D;\mu_{-3}&#x3D;\cdots&#x3D;\mu_{-K}&#x3D;0$ ，而目前的选择基期看系数的检验，检验的其实并不是这个原假设。因此，需要进行系数联合检验而不是关注单一系数的显著性。</li>
</ul>
<p>联合检验：如F检验，可以用来检查多个系数是否同时等于0。</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231106204518638.png" srcset="/img/loading.gif" lazyload alt="image-20231106204518638"></p>
<p>从（a）看，选择不同的基期，对事前系数的影响较大。</p>
<p>张子尧等（2022）对事前平行趋势检验有如下建议：</p>
<blockquote>
<p>第一，必须更加关注事前估计系数是否呈现出明显的时间趋势。个别事前估计系数显著可能仅仅是一种数据噪声导致的偶然现象，然而如果存在明显的事前趋势，可能预示着平行趋势假设不成立，这会直接威胁到事件研究法的识别假设可靠性，可能会导致估计结果产生严重偏误。因此，事前时间趋势(即使不显著)是比个别事前系数显著严重得多的大问题。若估计结果提示可能存在这一类问题，必须对该问题的来源进行详细的分析和讨论，并尽可能地做针对性处理以减轻对估计结果的干扰。</p>
<p>第二，由于事前时间趋势是关注重点，除了某些特殊情况外，必须对估计结果进行图形化以直观判别是否存在事前时间趋势。</p>
<p>第三，检验事前平行趋势应该对事前估计系数做联合检验而不是关注单一系数的显著性。</p>
</blockquote>
<h3 id="2-3-归并和截断数据"><a href="#2-3-归并和截断数据" class="headerlink" title="2.3 归并和截断数据"></a>2.3 归并和截断数据</h3><p><strong>数据归并</strong>(Binning)是指设定一个事件窗口 $[-K,L]$，将早于事件窗口的观测值 $(l\le-K)$ 的相对时期重新设定为 $-K$ 期，将晚于事件窗口的观测值 $l\ge L$ 的相对时期重新设定为 $L$ 期。</p>
<p><strong>数据截断</strong>(Trimming)同样是设定一个事件窗口，区别在于将事件窗口外的样本做删除而非归并。</p>
<p>归并数据的优势有二: 一是在样本中没有从未接受处理的控制组时可以避免共线性问题以识别平均处理效应，二是保留了全部样本从而提高了估计效率。在实践中应该避免对处理发生后时期进行归并;若事前平行趋势满足，可以对处理前时期做适当归并。</p>
<p>截断数据的优势在于产生的偏误较小，但有一定的样本选择问题，并降低估计效率。</p>
<p>实践中两种方式都见过。</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231106211031460.png" srcset="/img/loading.gif" lazyload alt="image-20231106211031460"></p>
<h4 id="2-4-正确控制组群异质性时间趋势"><a href="#2-4-正确控制组群异质性时间趋势" class="headerlink" title="2.4 正确控制组群异质性时间趋势"></a>2.4 正确控制组群异质性时间趋势</h4><p>事件研究法的核心识别假设是平行趋势假设。然而，由于涉及处理发生后不可观测的潜在结果，平行趋势假设本身是不可能被直接检验所证实或证伪的。因此，实践中研究者们一方面会检验事前平行趋势是否成立从而间接地为平行趋势假设提供支持，另一方面也考虑尽可能<strong>放松平行趋势假设</strong>，即允许处理组和控制组存在某种确定形式的趋势差异。最常见的是假设组间存在异质性的线性时间趋势，如下图所示，3 个处理组分别存在斜率为 1、0.5、0.2 的线性时间趋势，控制组不存在时间趋势。该数据生成过程显然不满足平行趋势假设，直接使用事件研究法无法得到平均处理效应的一致估计结果。针对这种情况，可以在回归方程的基础上进一步控制组群特定时间趋势:<br>$$<br>y_{it} &#x3D; \alpha_i + \gamma_gf(t) + \sum_{l&#x3D;-K}^{-2}\mu_l D_{it}^l + \sum_{l&#x3D;0}^L\beta_lD_{lt}^l + \epsilon_{it} \quad(3)<br>$$<br>式（3）中的 $f(t)$ 表示时间趋势项的函数形式，可以是线性的，也可以是二次形式的；$\gamma_g$ 表示时间趋势项的参数，$g$ 意味着不同组群的时间趋势项存在差异。下图中，控制组的时间趋势斜率 $\gamma_0 &#x3D; 0$ ，组群1、2、3 的时间趋势斜率分别为1、0.5 和0.2。</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231106211537255.png" srcset="/img/loading.gif" lazyload alt="image-20231106211537255"></p>
<p>实践中研究者们通常直接回归式（3），认为 $y_gf(t)$ 可以良好地控制潜在的组间时间趋势差异，从而确保估计系数 $\mu_l$ 和 $\beta_l$ 能够一致估计各期平均处理效应。然而事实<mark>并非如此</mark>！看例子：</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231106214116230.png" srcset="/img/loading.gif" lazyload alt="image-20231106214116230"></p>
<p>上图中，首先，可以发现由于平行趋势假设不满足，事件研究法无法正确识别处理前和处理后的真实平均处理效应。其次，令人惊讶的是，当控制住组群时间趋势项 $\gamma_g\times t$ 后，事件研究法不仅无法一致估计各期的平均因果效应，甚至会导致更大的估计偏误！并且，基期的选择也会对估计结果有很大影响！</p>
<p>如何处理组群间异质性时间趋势，目前主要有两种方法（我感觉两种方法本质上是一样的）：</p>
<ul>
<li><strong>手动剔除事前趋势的两阶段估计法</strong>：第一阶段使用未接受处理的子样本(控制组和尚未接受处理的处理组)估计组群异质性时间趋势并外推至处理后时期，从结果变量中剔除时间趋势(Detrend)。第二阶段使用剔除事前趋势后的结果变量进行事件研究法估计(Goodman-Bacon，2021; Dustmann 等，2022)。这种方法背后的逻辑很直观:如果组群时间趋势在处理前和处理后时期保持不变，使用未接受处理的子样本可以正确估计组群时间趋势，经过去趋势处理的结果变量重新满足平行趋势假设，事件研究法能够正确地估计出各期平均处理效应；</li>
<li><strong>插补法</strong>：既然问题出在使用全样本无法一致估计组群时间趋势项，那么一个自然的解决思路是使用未接受处理的子样本来正确地识别出组群时间趋势项 $\gamma_gf(t)$ 以及双向固定效应 $\alpha_i$ 和 $\lambda <em>t$ ，将其从结果变量 $y</em>{it}$ 中剔除后再进行回归估计。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231106220927856.png" srcset="/img/loading.gif" lazyload alt="image-20231106220927856"></p>
<p>⬆️，这里用两阶段DID和去除事前趋势都比较靠谱。</p>
<p>在实验中，我发现，只要将基期选择为最早的一期和处理前一期，控制时间趋势的话，结果相差不大的，在置信区间内，比如这里，选择-14期和-1期：</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231109112514196.png" srcset="/img/loading.gif" lazyload alt="image-20231109112514196"></p>
<blockquote>
<p>可以将时间趋势异质性的组群看成分段函数，起点分别是第一期和处理前一期，基期选择起点即可！</p>
</blockquote>
<h3 id="2-5-异质性处理效应条件下的事件研究法"><a href="#2-5-异质性处理效应条件下的事件研究法" class="headerlink" title="2.5 异质性处理效应条件下的事件研究法"></a>2.5 异质性处理效应条件下的事件研究法</h3><p>这部分也可以参考<a target="_blank" rel="noopener" href="https://yuzhangnju.github.io/2023/10/25/Handbook%20of%20DID%20family_20231026/">Handbook of DID family</a>里的相关内容！还是那些异质性DID的稳健估计量或诊断方法。</p>
<h4 id="2-5-1-异质性处理效应但无组间趋势差异"><a href="#2-5-1-异质性处理效应但无组间趋势差异" class="headerlink" title="2.5.1 异质性处理效应但无组间趋势差异"></a>2.5.1 异质性处理效应但无组间趋势差异</h4><p>即满足平行趋势假设和无预期效应假设，但处理效应在组间存在差异，此时使用TWFE得出的处理效应是有偏的。原因是计算处理效应的权重出了问题，有负权重的现象，会把较早接受处理的组当成对照组，即“禁止比较”。（和之前的异质性DID一样，这也是3.2中使用TWFE算出来的处理效应只有2.69的原因）</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231112160047110.png" srcset="/img/loading.gif" lazyload alt="image-20231112160047110"></p>
<p>解决方案主要有（感觉本质是一样的hh）：</p>
<ul>
<li>“组群-时”期平均处理效应估计法：首先估计出组群—时期平均处理效应 $ATT_{g,l}$ ，然后根据某种权重(等权重或组群规模权重)手动加权求出各相对时期的加权平均处理效应 $ATT_l$ 。由于在手动加权的过程中人为避免了负权重问题，这类估计量可以修正双向固定效应模型的偏误，正确地估计各时期的平均处理效应；</li>
<li>插补法：使用未受处理的子样本(包括控制组和处理前时期的处理组)估计拟合出处理组个体的反事实结果，而后计算出个体处理效应，最后加总得到各个相对时期的平均处理效应；</li>
<li>堆叠法：通过为每个处理组组群匹配一个由从未接受处理的控制组或尚未接受处理的处理组样本构成的特定控制组，再将匹配好的样本堆叠起来进行回归。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231112163237401.png" srcset="/img/loading.gif" lazyload alt="image-20231112163237401"></p>
<p><strong>异质性处理效应情形下的事前平行趋势检验</strong></p>
<ul>
<li>使用全样本会出现参照期和参照对象错误导致的权重错误问题</li>
<li>使用未受处理的子样本即可（包括在剔除接受处理的样本后使用TWFE（如下图），还是异质性稳健估计器（见上图处理时间前部分），都可以）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231112163818038.png" srcset="/img/loading.gif" lazyload alt="image-20231112163818038"></p>
<h4 id="2-5-2-异质性处理效应-异质性组间趋势"><a href="#2-5-2-异质性处理效应-异质性组间趋势" class="headerlink" title="2.5.2 异质性处理效应+异质性组间趋势"></a>2.5.2 异质性处理效应+异质性组间趋势</h4><p>似乎没有什么好的处理办法，作者举了些例子，如<strong>处理时点内生选择</strong>：</p>
<ul>
<li>阿森费尔特沉降(Ashenfelter’s Dip)：Ashenfelter(1978)在评估培训项目对工资的影响时发现职工平均收入在参加培训前有一个明显降低的趋势，后续研究发现这一现象的原因在于失业的工人为了更好地寻找到新工作而更有动机参加职业培训。由于参加职业培训的工人(处理组)与同时期未参加职业培训的工人(控制组)不具有良好的可比性，平行趋势假设很可能并不成立，导致事件研究法无法正确识别因果效应(Heckman 和 Smith，1999)。 另一个常见的例子是离职对员工收入的影响。员工离职有两种可能情形，一种是主动辞职去新的企业工作以获得更高的收入，另一种是被企业强制解雇导致被动失业。显然，不同情形的离职对员工收入的影响存在巨大差异:主动辞职者通常可以获得更高的收入，而被迫失业者收入会大幅度降低。更为严重的问题在于，主动辞职者和被迫失业者(处理组)与持续工作者(控制组)的反事实收入很可能有不同的时间趋势，此时平行趋势假设不再成立。（参加培训这样的事件内生性太强，会有自我选择的情况）</li>
<li>在举个例子，就是下图的数据生成过程：结果变量是个人收入，事件为更换工作，虚线为未更换工作的个人收入反事实潜在结果。从图中可以看到，当个人预期到企业未来经营困难、收入可能会下降时会考虑更换工作;能力越强的员工(事前收入越高)越容易找到新职位，因此会更早更换工作(处理时点靠前)，并且新职位的收入也会越高(处理效应更强); 反之，能力较低的员工更难找到新职位，所以更换工作较晚(处理时点靠后)并且新职位的收入更低(处理效应更弱)。由于处理组未受处理的反事实潜在结果与控制组不平行，不满足平行趋势假设。 在这种情形下，<strong>无论是基于双向固定效应模型的传统事件研究法还是异质性处理效应稳健估计量都存在估计偏误，<mark>都无法</mark>正确估计各期平均处理效应</strong>。</li>
</ul>
<p>此时的数据情况类似下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231112164904412.png" srcset="/img/loading.gif" lazyload alt="image-20231112164904412"></p>
<p>真实处理效应如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231112165018003.png" srcset="/img/loading.gif" lazyload alt="image-20231112165018003"></p>
<p>而TWFE和各类稳健估计量都不能很好地准确估计：</p>
<p><img src="https://cdn.jsdelivr.net/gh/yuzhangnju/image2022/image-20231112164748356.png" srcset="/img/loading.gif" lazyload alt="image-20231112164748356"></p>
<p><strong>怎么知道自己的数据是不是可以有效估计的呢？或者估计结果有没有什么问题？</strong></p>
<ul>
<li>用TWFE试试看，再用异质性稳健估计量看看，如果两者的结果相差较大，就要注意问题出在哪里！</li>
</ul>
<h3 id="2-6-其他问题"><a href="#2-6-其他问题" class="headerlink" title="2.6 其他问题"></a>2.6 其他问题</h3><ul>
<li>个体在事件窗口内发生多次事件如何处理</li>
<li>存在影响强度不同的事件该如何处理</li>
<li>事件日期存在空间相关会怎样</li>
</ul>
<p>等等，可以参考<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/5kC3RyyhZkOILtFrlbQOag">【香樟推文2919】ES，启动！——事件研究法入门指南</a></p>
<h2 id="3-数据与代码"><a href="#3-数据与代码" class="headerlink" title="3 数据与代码"></a>3 数据与代码</h2><h3 id="3-1-数据生成过程"><a href="#3-1-数据生成过程" class="headerlink" title="3.1 数据生成过程"></a>3.1 数据生成过程</h3><p>数据生成过程非常重要！！！</p>
<p>一定要理解，难以理解的地方咨询ChatGPT！！！</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">clear</span> all<br><br><span class="hljs-keyword">set</span> seed 20230101<br><br><span class="hljs-comment">***********************</span><br><span class="hljs-comment">**       DGP1        **</span><br><span class="hljs-comment">***********************</span><br><span class="hljs-comment">*  - 交错处理时点</span><br><span class="hljs-comment">*  - 同质性处理效应路径</span><br><span class="hljs-comment">*  -满足平行趋势</span><br><br><span class="hljs-comment">* N=400, T=20, G=4</span><br><span class="hljs-keyword">clear</span> all    <br><span class="hljs-keyword">set</span> obs 400<br><span class="hljs-keyword">gen</span> id = _n<br><span class="hljs-keyword">expand</span> 20<br><span class="hljs-keyword">bysort</span> id: <span class="hljs-keyword">gen</span> time = _n  <br><br><span class="hljs-comment">* 生成个体固定效应</span><br><span class="hljs-keyword">gen</span>  unit_c     = runiform(0,10) <span class="hljs-keyword">if</span> time==1<br><span class="hljs-keyword">egen</span> unit_spec  = <span class="hljs-keyword">mean</span>(unit_c), <span class="hljs-keyword">by</span>(id)<br><br><span class="hljs-keyword">gen</span> x = runiform(0,1)<br><span class="hljs-keyword">gen</span>     indicator_c = unit_c + 1*x <span class="hljs-comment">//在stata里，空值的观测不会被加法填补</span><br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">sum</span> indicator_c,<span class="hljs-keyword">d</span><br><span class="hljs-keyword">scalar</span>  threshold1   = <span class="hljs-built_in">r</span>(p25) <span class="hljs-comment">//创建四分位的标量</span><br><span class="hljs-keyword">scalar</span>  threshold2   = <span class="hljs-built_in">r</span>(p50)<br><span class="hljs-keyword">scalar</span>  threshold3   = <span class="hljs-built_in">r</span>(p75)<br><span class="hljs-keyword">egen</span>    indicator   = <span class="hljs-keyword">mean</span>(indicator_c), <span class="hljs-keyword">by</span>(id)<br><span class="hljs-keyword">gen</span>     treat = 1<br><span class="hljs-keyword">replace</span> treat = 2 <span class="hljs-keyword">if</span> indicator&gt;threshold1<br><span class="hljs-keyword">replace</span> treat = 3 <span class="hljs-keyword">if</span> indicator&gt;threshold2<br><span class="hljs-keyword">replace</span> treat = 4 <span class="hljs-keyword">if</span> indicator&gt;threshold3<br><span class="hljs-keyword">tab</span> treat, <span class="hljs-keyword">gen</span>(group)<br><br><span class="hljs-keyword">gen</span> timing = . <span class="hljs-comment">//生成接受处理的年份</span><br><span class="hljs-keyword">replace</span> timing = 5 <span class="hljs-keyword">if</span> treat==2<br><span class="hljs-keyword">replace</span> timing = 10 <span class="hljs-keyword">if</span> treat==3<br><span class="hljs-keyword">replace</span> timing = 15 <span class="hljs-keyword">if</span> treat==4<br><br><span class="hljs-comment">* 定义潜在结果y0和y1</span><br><span class="hljs-keyword">gen</span> rel_date = time-timing <span class="hljs-comment">//生成接受处理的相对年份</span><br><span class="hljs-keyword">replace</span> rel_date = 0 <span class="hljs-keyword">if</span> <span class="hljs-built_in">mi</span>(rel_date) <span class="hljs-comment">//如果该个体没有接受处理，改为0</span><br><span class="hljs-keyword">gen</span> <span class="hljs-keyword">post</span> = rel_date&gt;=0 <span class="hljs-comment">//生成post虚拟变量，处理之前为0，之后为1</span><br><span class="hljs-keyword">gen</span> group_level = 10*group2 + 3*group3 -3*group4 <span class="hljs-comment">//用于模拟不同分组的基础水平效应</span><br><span class="hljs-keyword">gen</span> group_trend = 0 <span class="hljs-comment">//平行趋势</span><br><span class="hljs-keyword">gen</span> tauit =  (1*group2 + 1*group3 + 1*group4)*<span class="hljs-keyword">post</span>*(rel_date+1) <span class="hljs-comment">//生成潜在的处理效应变量tauit。这里它被设定为对于接受处理的个体（由post指示），随时间（rel_date+1）线性增加。该效应对于所有处理组都是相同的。每一组的系数都是1，表明处理效应不存在组间差异</span><br><span class="hljs-keyword">gen</span> y0 = group_level + group_trend + unit_spec + runiform(0,10)<br><span class="hljs-keyword">gen</span> y1 = group_level + group_trend + unit_spec + tauit + runiform(0,10)<br><span class="hljs-comment">* 生成观测样本y </span><br><span class="hljs-keyword">cap</span> <span class="hljs-keyword">drop</span> y<br><span class="hljs-keyword">gen</span> <span class="hljs-keyword">D</span> = 0<br><span class="hljs-keyword">replace</span> <span class="hljs-keyword">D</span> = 1 <span class="hljs-keyword">if</span> rel_date&gt;=0&amp;<span class="hljs-built_in">inlist</span>(treat,2,3,4)<br><span class="hljs-keyword">gen</span> y = (1-<span class="hljs-keyword">D</span>)*y0 + <span class="hljs-keyword">D</span>*y1 <span class="hljs-comment">//处理前，y=y0，处理组处理后，y=y1</span><br><br><br><span class="hljs-keyword">forvalues</span> k = 14(-1)2 &#123;<br>   <span class="hljs-keyword">gen</span> relb_<span class="hljs-symbol">`k&#x27;</span> = rel_date == -<span class="hljs-symbol">`k&#x27;</span>  <span class="hljs-comment">// 事前相对时点</span><br>   <span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> relb_<span class="hljs-symbol">`k&#x27;</span> <span class="hljs-string">&quot;-`k&#x27;&quot;</span>        <span class="hljs-comment">// label用于画图</span><br>&#125;<br><br><span class="hljs-keyword">gen</span> rel_base = rel_date==-1 <span class="hljs-comment">//基期</span><br><span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> rel_base <span class="hljs-string">&quot;-1&quot;</span><br><br><span class="hljs-keyword">forvalues</span> k = 0/15 &#123;<br>    <span class="hljs-keyword">gen</span> relf_<span class="hljs-symbol">`k&#x27;</span> = rel_date == <span class="hljs-symbol">`k&#x27;</span>  <span class="hljs-comment">// 事后相对时点</span><br>    <span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> relf_<span class="hljs-symbol">`k&#x27;</span> <span class="hljs-string">&quot;`k&#x27;&quot;</span>            <span class="hljs-comment">// label用于画图</span><br>&#125;<br><span class="hljs-keyword">for</span> <span class="hljs-keyword">var</span> relb_* relf_* rel_base: <span class="hljs-keyword">replace</span> X = 0 <span class="hljs-keyword">if</span> group1==1 <span class="hljs-comment">// 控制组的相对时点全部定义为0</span><br><span class="hljs-keyword">save</span> simu_data_DGP01, <span class="hljs-keyword">replace</span><br><br><br><br><br><span class="hljs-comment">***********************</span><br><span class="hljs-comment">**       DGP2        **</span><br><span class="hljs-comment">***********************</span><br><span class="hljs-comment">*  -交错处理时点</span><br><span class="hljs-comment">*  -同质性处理效应路径</span><br><span class="hljs-comment">*  -存在组间趋势差异，不满足平行趋势</span><br><br><span class="hljs-comment">* 设定随机数种子</span><br><span class="hljs-keyword">set</span> seed 20230101<br><br><span class="hljs-keyword">clear</span> all    <br><span class="hljs-keyword">set</span> obs 400<br><span class="hljs-keyword">gen</span> id = _n<br><span class="hljs-keyword">expand</span> 20<br><span class="hljs-keyword">bysort</span> id: <span class="hljs-keyword">gen</span> time = _n  <br><br><span class="hljs-comment">* 生成个体固定效应</span><br><span class="hljs-keyword">gen</span>  unit_c     = runiform(0,10) <span class="hljs-keyword">if</span> time==1<br><span class="hljs-keyword">egen</span> unit_spec  = <span class="hljs-keyword">mean</span>(unit_c), <span class="hljs-keyword">by</span>(id)<br><span class="hljs-keyword">gen</span> x = runiform(0,1)<br><br><span class="hljs-keyword">gen</span>     indicator_c = unit_c + 1*x<br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">sum</span> indicator_c,<span class="hljs-keyword">d</span><br><span class="hljs-keyword">scalar</span>  threshold1   = <span class="hljs-built_in">r</span>(p25)<br><span class="hljs-keyword">scalar</span>  threshold2   = <span class="hljs-built_in">r</span>(p50)<br><span class="hljs-keyword">scalar</span>  threshold3   = <span class="hljs-built_in">r</span>(p75)<br><span class="hljs-keyword">egen</span>    indicator   = <span class="hljs-keyword">mean</span>(indicator_c), <span class="hljs-keyword">by</span>(id)<br><span class="hljs-keyword">gen</span>     treat = 1<br><span class="hljs-keyword">replace</span> treat = 2 <span class="hljs-keyword">if</span> indicator&gt;threshold1<br><span class="hljs-keyword">replace</span> treat = 3 <span class="hljs-keyword">if</span> indicator&gt;threshold2<br><span class="hljs-keyword">replace</span> treat = 4 <span class="hljs-keyword">if</span> indicator&gt;threshold3<br><span class="hljs-keyword">tab</span> treat, <span class="hljs-keyword">gen</span>(group)<br><br><span class="hljs-keyword">gen</span> timing = .<br><span class="hljs-keyword">replace</span> timing = 5 <span class="hljs-keyword">if</span> treat==2<br><span class="hljs-keyword">replace</span> timing = 10 <span class="hljs-keyword">if</span> treat==3<br><span class="hljs-keyword">replace</span> timing = 15 <span class="hljs-keyword">if</span> treat==4<br><br><span class="hljs-comment">* 定义潜在结果y0和y1</span><br><span class="hljs-keyword">gen</span> rel_date = time-timing<br><span class="hljs-keyword">replace</span> rel_date = 0 <span class="hljs-keyword">if</span> <span class="hljs-built_in">mi</span>(rel_date)<br><span class="hljs-keyword">gen</span> <span class="hljs-keyword">post</span> = rel_date&gt;=0<br><span class="hljs-keyword">gen</span> group_level = 10*group2 + 3*group3 -3*group4<br><span class="hljs-keyword">gen</span> group_trend = (0*group1 + 1*group2 + 0.5*group3 + 0.2*group4)*time <span class="hljs-comment">//之前这里是0，现在这里给2 3 4组分别设置了斜率为 1 0.5 0.2 的时间趋势，这个时间趋势在所有观测到最早一期就有的，不是等到处理时点才有，因此破坏了平行趋势</span><br><span class="hljs-keyword">gen</span> tauit =  (1*group2 + 1*group3 + 1*group4)*<span class="hljs-keyword">post</span>*(1 + rel_date) <span class="hljs-comment">//short-run and dynamic effects</span><br><span class="hljs-keyword">gen</span> y0 = group_level + group_trend + unit_spec + runiform(0,10)<br><span class="hljs-keyword">gen</span> y1 = group_level + group_trend + unit_spec + tauit + runiform(0,10)<br><span class="hljs-comment">* 生成观测样本y </span><br><span class="hljs-keyword">cap</span> <span class="hljs-keyword">drop</span> y<br><span class="hljs-keyword">gen</span> <span class="hljs-keyword">D</span> = 0<br><span class="hljs-keyword">replace</span> <span class="hljs-keyword">D</span> = 1 <span class="hljs-keyword">if</span> rel_date&gt;=0&amp;<span class="hljs-built_in">inlist</span>(treat,2,3,4)<br><span class="hljs-keyword">gen</span> y = (1-<span class="hljs-keyword">D</span>)*y0 + <span class="hljs-keyword">D</span>*y1 <br><br><span class="hljs-keyword">forvalues</span> k = 14(-1)2 &#123;<br>   <span class="hljs-keyword">gen</span> relb_<span class="hljs-symbol">`k&#x27;</span> = rel_date == -<span class="hljs-symbol">`k&#x27;</span>  <span class="hljs-comment">// 事前相对时点</span><br>   <span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> relb_<span class="hljs-symbol">`k&#x27;</span> <span class="hljs-string">&quot;-`k&#x27;&quot;</span>        <span class="hljs-comment">// label用于画图</span><br>&#125;<br><br><span class="hljs-keyword">gen</span> rel_base = rel_date==-1 <span class="hljs-comment">//基期</span><br><span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> rel_base <span class="hljs-string">&quot;-1&quot;</span><br><br><span class="hljs-keyword">forvalues</span> k = 0/15 &#123;<br>    <span class="hljs-keyword">gen</span> relf_<span class="hljs-symbol">`k&#x27;</span> = rel_date == <span class="hljs-symbol">`k&#x27;</span>  <span class="hljs-comment">// 事后相对时点</span><br>    <span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> relf_<span class="hljs-symbol">`k&#x27;</span> <span class="hljs-string">&quot;`k&#x27;&quot;</span>            <span class="hljs-comment">// label用于画图</span><br>&#125;<br><span class="hljs-keyword">for</span> <span class="hljs-keyword">var</span> relb_* relf_* rel_base: <span class="hljs-keyword">replace</span> X = 0 <span class="hljs-keyword">if</span> group1==1 <span class="hljs-comment">// 控制组的相对时点全部定义为0</span><br><br><span class="hljs-keyword">save</span> simu_data_DGP02, <span class="hljs-keyword">replace</span><br><br><br><br><span class="hljs-comment">***********************</span><br><span class="hljs-comment">**       DGP3        **</span><br><span class="hljs-comment">***********************</span><br><span class="hljs-comment">*  -交错处理时点</span><br><span class="hljs-comment">*  -异质性处理效应</span><br><span class="hljs-comment">*  -满足平行趋势</span><br><br><span class="hljs-comment">* 设定随机数种子</span><br><span class="hljs-keyword">set</span> seed 20230101<br><br><span class="hljs-keyword">clear</span> all    <br><span class="hljs-keyword">set</span> obs 400<br><span class="hljs-keyword">gen</span> id = _n<br><span class="hljs-keyword">expand</span> 20<br><span class="hljs-keyword">bysort</span> id: <span class="hljs-keyword">gen</span> time = _n  <br><br><span class="hljs-comment">* 生成个体固定效应</span><br><span class="hljs-keyword">gen</span>  unit_c     = runiform(0,10) <span class="hljs-keyword">if</span> time==1<br><span class="hljs-keyword">egen</span> unit_spec  = <span class="hljs-keyword">mean</span>(unit_c), <span class="hljs-keyword">by</span>(id)<br><br><span class="hljs-keyword">gen</span> x = runiform(0,1)<br><span class="hljs-keyword">gen</span>     indicator_c = unit_c + 1*x<br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">sum</span> indicator_c,<span class="hljs-keyword">d</span><br><span class="hljs-keyword">scalar</span>  threshold1   = <span class="hljs-built_in">r</span>(p25)<br><span class="hljs-keyword">scalar</span>  threshold2   = <span class="hljs-built_in">r</span>(p50)<br><span class="hljs-keyword">scalar</span>  threshold3   = <span class="hljs-built_in">r</span>(p75)<br><span class="hljs-keyword">egen</span>    indicator   = <span class="hljs-keyword">mean</span>(indicator_c), <span class="hljs-keyword">by</span>(id)<br><span class="hljs-keyword">gen</span>     treat = 1<br><span class="hljs-keyword">replace</span> treat = 2 <span class="hljs-keyword">if</span> indicator&gt;threshold1<br><span class="hljs-keyword">replace</span> treat = 3 <span class="hljs-keyword">if</span> indicator&gt;threshold2<br><span class="hljs-keyword">replace</span> treat = 4 <span class="hljs-keyword">if</span> indicator&gt;threshold3<br><span class="hljs-keyword">tab</span> treat, <span class="hljs-keyword">gen</span>(group)<br><br><span class="hljs-keyword">gen</span> timing = .<br><span class="hljs-keyword">replace</span> timing = 5 <span class="hljs-keyword">if</span> treat==2<br><span class="hljs-keyword">replace</span> timing = 10 <span class="hljs-keyword">if</span> treat==3<br><span class="hljs-keyword">replace</span> timing = 15 <span class="hljs-keyword">if</span> treat==4<br><br><span class="hljs-comment">* 定义潜在结果y0和y1</span><br><span class="hljs-keyword">gen</span> rel_date = time-timing<br><span class="hljs-keyword">replace</span> rel_date = 0 <span class="hljs-keyword">if</span> <span class="hljs-built_in">mi</span>(rel_date)<br><span class="hljs-keyword">gen</span> <span class="hljs-keyword">post</span> = rel_date&gt;=0<br><span class="hljs-keyword">gen</span> group_level = 10*group2 + 3*group3 -3*group4<br><span class="hljs-keyword">gen</span> group_trend = 0 <span class="hljs-comment">//满足平行趋势</span><br><span class="hljs-keyword">gen</span> tauit =  (0.5*group2 + 1*group3 + 2*group4)*<span class="hljs-keyword">post</span>*(rel_date+1) <span class="hljs-comment">//这里给每组设置了不同的系数，之前的都是1，即处理效应异质性</span><br><span class="hljs-keyword">gen</span> y0 = group_level + group_trend + unit_spec + runiform(0,10)<br><span class="hljs-keyword">gen</span> y1 = group_level + group_trend + unit_spec + tauit + runiform(0,10)<br><br><span class="hljs-comment">* 生成观测样本y </span><br><span class="hljs-keyword">cap</span> <span class="hljs-keyword">drop</span> y<br><span class="hljs-keyword">gen</span> <span class="hljs-keyword">D</span> = 0<br><span class="hljs-keyword">replace</span> <span class="hljs-keyword">D</span> = 1 <span class="hljs-keyword">if</span> rel_date&gt;=0&amp;<span class="hljs-built_in">inlist</span>(treat,2,3,4)<br><span class="hljs-keyword">gen</span> y = (1-<span class="hljs-keyword">D</span>)*y0 + <span class="hljs-keyword">D</span>*y1 <br><br><span class="hljs-keyword">gen</span> rel_date_cut = rel_date<br><span class="hljs-keyword">local</span> pre_cut  = 14<br><span class="hljs-keyword">local</span> post_cut = 15<br><span class="hljs-keyword">replace</span> rel_date_cut = -<span class="hljs-symbol">`pre_cut&#x27;</span>  <span class="hljs-keyword">if</span> rel_date&lt;-<span class="hljs-symbol">`pre_cut&#x27;</span><br><span class="hljs-keyword">replace</span> rel_date_cut = <span class="hljs-symbol">`post_cut&#x27;</span> <span class="hljs-keyword">if</span> rel_date&gt;<span class="hljs-symbol">`post_cut&#x27;</span><br><span class="hljs-keyword">tab</span> rel_date_cut<br><br><span class="hljs-keyword">forvalues</span> k = <span class="hljs-symbol">`pre_cut&#x27;</span>(-1)2 &#123;<br>   <span class="hljs-keyword">gen</span> relb_<span class="hljs-symbol">`k&#x27;</span> = rel_date_cut == -<span class="hljs-symbol">`k&#x27;</span><br>   <span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> relb_<span class="hljs-symbol">`k&#x27;</span> <span class="hljs-string">&quot;-`k&#x27;&quot;</span><br>&#125;<br><span class="hljs-keyword">gen</span> rel_base = rel_date_cut==-1<br><span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> rel_base <span class="hljs-string">&quot;-1&quot;</span><br><span class="hljs-keyword">forvalues</span> k = 0/<span class="hljs-symbol">`post_cut&#x27;</span> &#123;<br>    <span class="hljs-keyword">gen</span> relf_<span class="hljs-symbol">`k&#x27;</span> = rel_date_cut == <span class="hljs-symbol">`k&#x27;</span><br>    <span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> relf_<span class="hljs-symbol">`k&#x27;</span> <span class="hljs-string">&quot;`k&#x27;&quot;</span><br>&#125;<br><span class="hljs-keyword">for</span> <span class="hljs-keyword">var</span> relb_* relf_* rel_base: <span class="hljs-keyword">replace</span> X = 0 <span class="hljs-keyword">if</span> group1==1 <span class="hljs-comment">// 控制组的相对数量全是0</span><br><br><span class="hljs-keyword">save</span> simu_data_DGP03, <span class="hljs-keyword">replace</span><br><br><br><span class="hljs-comment">***********************</span><br><span class="hljs-comment">**       DGP4        **</span><br><span class="hljs-comment">***********************</span><br><span class="hljs-comment">*  -交错处理时点</span><br><span class="hljs-comment">*  -异质性处理效应</span><br><span class="hljs-comment">*  -存在组间趋势差异，不满足平行趋势</span><br><br><span class="hljs-comment">* 设定随机数种子</span><br><span class="hljs-keyword">set</span> seed 20230101<br><br><span class="hljs-keyword">clear</span> all    <br><span class="hljs-keyword">set</span> obs 400<br><span class="hljs-keyword">gen</span> id = _n<br><span class="hljs-keyword">expand</span> 20<br><span class="hljs-keyword">bysort</span> id: <span class="hljs-keyword">gen</span> time = _n  <br><br><span class="hljs-comment">* 生成个体固定效应</span><br><span class="hljs-keyword">gen</span>  unit_c     = runiform(0,10) <span class="hljs-keyword">if</span> time==1<br><span class="hljs-keyword">egen</span> unit_fe  = <span class="hljs-keyword">mean</span>(unit_c), <span class="hljs-keyword">by</span>(id)<br><br><span class="hljs-keyword">gen</span>     indicator_c = unit_c <br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">sum</span> indicator_c,<span class="hljs-keyword">d</span><br><span class="hljs-keyword">scalar</span>  threshold1   = <span class="hljs-built_in">r</span>(p25)<br><span class="hljs-keyword">scalar</span>  threshold2   = <span class="hljs-built_in">r</span>(p50)<br><span class="hljs-keyword">scalar</span>  threshold3   = <span class="hljs-built_in">r</span>(p75)<br><span class="hljs-keyword">egen</span>    indicator   = <span class="hljs-keyword">mean</span>(indicator_c), <span class="hljs-keyword">by</span>(id)<br><span class="hljs-keyword">gen</span>     treat = 1<br><span class="hljs-keyword">replace</span> treat = 2 <span class="hljs-keyword">if</span> indicator&gt;threshold1<br><span class="hljs-keyword">replace</span> treat = 3 <span class="hljs-keyword">if</span> indicator&gt;threshold2<br><span class="hljs-keyword">replace</span> treat = 4 <span class="hljs-keyword">if</span> indicator&gt;threshold3<br><span class="hljs-keyword">tab</span> treat, <span class="hljs-keyword">gen</span>(group)<br><br><span class="hljs-keyword">gen</span> timing = .<br><span class="hljs-keyword">replace</span> timing = 5 <span class="hljs-keyword">if</span> treat==2<br><span class="hljs-keyword">replace</span> timing = 10 <span class="hljs-keyword">if</span> treat==3<br><span class="hljs-keyword">replace</span> timing = 15 <span class="hljs-keyword">if</span> treat==4<br><br><span class="hljs-comment">* 定义潜在结果y0和y1</span><br><span class="hljs-keyword">gen</span> rel_date = time-timing<br><span class="hljs-keyword">replace</span> rel_date = 0 <span class="hljs-keyword">if</span> <span class="hljs-built_in">mi</span>(rel_date)<br><span class="hljs-keyword">gen</span> <span class="hljs-keyword">post</span> = rel_date&gt;=0<br><span class="hljs-keyword">gen</span> group_level = 40*group2 + 25*group3 +10*group4<br><span class="hljs-keyword">gen</span> group_trend = 0<br><span class="hljs-keyword">egen</span> X_cf = <span class="hljs-keyword">mean</span>(unit_c), <span class="hljs-keyword">by</span>(treat) <span class="hljs-comment">//下面会纳入计算，因此有了组建趋势差异，不满足平行趋势</span><br><br><span class="hljs-keyword">gen</span> tauit =  (2*group2 + 1*group3 + 0.5*group4)*<span class="hljs-keyword">post</span>*(rel_date+1) <span class="hljs-comment">//异质性处理效应</span><br><span class="hljs-keyword">gen</span> y0 = group_level + group_trend  - 0.1*X_cf*rel_date*<span class="hljs-keyword">post</span> + runiform(0,10)<br><span class="hljs-keyword">gen</span> y1 = group_level + group_trend  - 0.1*X_cf*rel_date*<span class="hljs-keyword">post</span> + tauit + runiform(0,10)<br><span class="hljs-comment">* 生成观测样本y </span><br><span class="hljs-keyword">cap</span> <span class="hljs-keyword">drop</span> y<br><span class="hljs-keyword">gen</span> <span class="hljs-keyword">D</span> = 0<br><span class="hljs-keyword">replace</span> <span class="hljs-keyword">D</span> = 1 <span class="hljs-keyword">if</span> rel_date&gt;=0&amp;<span class="hljs-built_in">inlist</span>(treat,2,3,4)<br><span class="hljs-keyword">gen</span> y = (1-<span class="hljs-keyword">D</span>)*y0 + <span class="hljs-keyword">D</span>*y1 <br><br><span class="hljs-keyword">gen</span> rel_date_cut = rel_date<br><span class="hljs-keyword">local</span> pre_cut  = 14<br><span class="hljs-keyword">local</span> post_cut = 15<br><span class="hljs-keyword">replace</span> rel_date_cut = -<span class="hljs-symbol">`pre_cut&#x27;</span>  <span class="hljs-keyword">if</span> rel_date&lt;-<span class="hljs-symbol">`pre_cut&#x27;</span><br><span class="hljs-keyword">replace</span> rel_date_cut = <span class="hljs-symbol">`post_cut&#x27;</span> <span class="hljs-keyword">if</span> rel_date&gt;<span class="hljs-symbol">`post_cut&#x27;</span><br><span class="hljs-keyword">tab</span> rel_date_cut<br><br><span class="hljs-keyword">forvalues</span> k = <span class="hljs-symbol">`pre_cut&#x27;</span>(-1)2 &#123;<br>   <span class="hljs-keyword">gen</span> relb_<span class="hljs-symbol">`k&#x27;</span> = rel_date_cut == -<span class="hljs-symbol">`k&#x27;</span><br>   <span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> relb_<span class="hljs-symbol">`k&#x27;</span> <span class="hljs-string">&quot;-`k&#x27;&quot;</span><br>&#125;<br><span class="hljs-keyword">gen</span> rel_base = rel_date_cut==-1<br><span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> rel_base <span class="hljs-string">&quot;-1&quot;</span><br><span class="hljs-keyword">forvalues</span> k = 0/<span class="hljs-symbol">`post_cut&#x27;</span> &#123;<br>    <span class="hljs-keyword">gen</span> relf_<span class="hljs-symbol">`k&#x27;</span> = rel_date_cut == <span class="hljs-symbol">`k&#x27;</span><br>    <span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> relf_<span class="hljs-symbol">`k&#x27;</span> <span class="hljs-string">&quot;`k&#x27;&quot;</span><br>&#125;<br><span class="hljs-keyword">for</span> <span class="hljs-keyword">var</span> relb_* relf_* rel_base: <span class="hljs-keyword">replace</span> X = 0 <span class="hljs-keyword">if</span> group1==1 <span class="hljs-comment">// 控制组的相对数量全是0</span><br><span class="hljs-keyword">save</span> simu_data_DGP04, <span class="hljs-keyword">replace</span><br></code></pre></td></tr></table></figure>

<h3 id="3-2-同质性处理效应路径的情况"><a href="#3-2-同质性处理效应路径的情况" class="headerlink" title="3.2 同质性处理效应路径的情况"></a>3.2 同质性处理效应路径的情况</h3><p>即不同组群的冲击时点不同，但效果一致，都随时间线性增加。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-comment">*注意在当前目录下需要有一个名为figure的文件夹，用来存放输出的图片</span><br><br><span class="hljs-keyword">clear</span> all<br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       图2        **</span><br><span class="hljs-comment">**********************</span><br><br><span class="hljs-comment">* 运行DGP文件生成数据</span><br><span class="hljs-keyword">use</span> simu_data_DGP01, <span class="hljs-keyword">clear</span><br><br><span class="hljs-keyword">preserve</span> <br><span class="hljs-keyword">collapse</span> (<span class="hljs-keyword">mean</span>) y, <span class="hljs-keyword">by</span>(treat time) <span class="hljs-comment">//将数据集压缩为y变量的均值，并且这些均值是按照time（时间）和treat（处理组）变量分组的。在这个压缩后的数据集中，每个treat和time组合只有一个观察值，它代表该组合的y的均值。下面的是绘制处理组treat==2的散点图，使用线连接(c(l))和圆形标记(m(o))。o\s\t\d分别表示圆形、方形、三角形和菱形</span><br><span class="hljs-keyword">tw</span>  (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==2, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(o)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==3, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(s)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==4, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(t)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==1, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(<span class="hljs-keyword">d</span>)), ylabel(0(10)40) <span class="hljs-comment">///</span><br>    subtit(<span class="hljs-string">&quot;（a）模拟数据&quot;</span>, pos(6)) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;组群1 (T*=5)&quot;</span> 2 <span class="hljs-string">&quot;组群2 (T*=10)&quot;</span> 3 <span class="hljs-string">&quot;组群3 (T*=15)&quot;</span> 4 <span class="hljs-string">&quot;控制组&quot;</span> ) <span class="hljs-variable">$tllgd</span> col(1)) xtitle(<span class="hljs-string">&quot;时期&quot;</span>) ytitle(<span class="hljs-string">&quot;结果变量Y&quot;</span>) scale(1) name(Homo1)<br><span class="hljs-keyword">restore</span><br><br><span class="hljs-comment">* 图2b</span><br><span class="hljs-keyword">preserve</span> <br><span class="hljs-keyword">collapse</span> (<span class="hljs-keyword">mean</span>) att=tauit, <span class="hljs-keyword">by</span>(treat rel_date) <span class="hljs-comment">//画出处理效应ATT</span><br><span class="hljs-keyword">replace</span> att = att+0.5 <span class="hljs-keyword">if</span> treat==3<br><span class="hljs-keyword">replace</span> att = att+1 <span class="hljs-keyword">if</span> treat==2<br><span class="hljs-keyword">tw</span>  (<span class="hljs-keyword">sc</span> att rel_date <span class="hljs-keyword">if</span> treat==2, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(o)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> att rel_date <span class="hljs-keyword">if</span> treat==3, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(s)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> att rel_date <span class="hljs-keyword">if</span> treat==4, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(t)), xlabel(-15(5)15) <span class="hljs-comment">///</span><br>    xline(-0.5, lc(gs8) lp(dash)) <span class="hljs-comment">///</span><br>    xtitle(<span class="hljs-string">&quot;相对处理时期&quot;</span>) ytitle(<span class="hljs-string">&quot;平均处理效应 (ATT)&quot;</span>) <span class="hljs-comment">///</span><br>    subtit(<span class="hljs-string">&quot;（b）真实平均处理效应&quot;</span>, pos(6)) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;组群1 (T*=5)&quot;</span> 2 <span class="hljs-string">&quot;组群2 (T*=10)&quot;</span> 3 <span class="hljs-string">&quot;组群3 (T*=15)&quot;</span>) <span class="hljs-variable">$tllgd</span> col(1)) scale(1) name(Homo2)<br><span class="hljs-keyword">restore</span><br><span class="hljs-keyword">gr</span> combine Homo1 Homo2, xsize(10) scale(1.5)<br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_ATT.png&quot;</span>, width(3000) <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_ATT.svg&quot;</span>, <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> <span class="hljs-keyword">save</span> figure/ES_ATT.gph, <span class="hljs-keyword">replace</span><br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       图3        **</span><br><span class="hljs-comment">**********************</span><br><span class="hljs-keyword">use</span> simu_data_DGP01, <span class="hljs-keyword">clear</span><br><br><span class="hljs-comment">* TWFE</span><br>reghdfe y relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 o.rel_base relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11 relf_12 relf_13 relf_14 relf_15, a(id time) <span class="hljs-keyword">cluster</span>(id)<br>eststo ES_TWFE <span class="hljs-comment">//注意，o.rel_base 就是选择基准期，o 表示 omitted</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">********************************************************************************</span><br><span class="hljs-comment">reghdfe y c.D, a(id time) cluster(id) //再用DID看看，发现平均处理效应是2.69,似乎不对？**</span><br><span class="hljs-comment">********************************************************************************</span><br><span class="hljs-comment">//2.69肯定是不对，固定控制组，单独看123组的处理效应分别是8.66 5.93 3.27；真实的处理效应应该是6.76</span><br><span class="hljs-comment">//sum taui, 发现均值是2.79，和TWFE的结果一致，表明TWFE确实存在负权重问题</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">//时间异质性也算是异质性DID，需要用异质性稳健估计器，下面试试csdid</span><br><span class="hljs-comment">gen gvar = timing</span><br><span class="hljs-comment">replace gvar = 0 if timing == .</span><br><span class="hljs-comment">csdid y, ivar(id) time(time) gvar(gvar) method(dripw) agg(simple) //能算出来一个平均处理效应6.67，并且和6.76最接近！</span><br><span class="hljs-comment">csdid y, ivar(id) time(time) gvar(gvar) method(dripw) agg(group) //每个组群的处理效应跟我上面手动算的差不多哈哈</span><br><span class="hljs-comment">csdid y, ivar(id) time(time) gvar(gvar) method(dripw) agg(calendar) //按日历时间的结果，可能不是我们想要的</span><br><span class="hljs-comment">csdid y, ivar(id) time(time) gvar(gvar) method(dripw) agg(event) //这个结果和上面的reghdfe的结果很接近，基本一样，是我们想要的</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">gl</span> leadall <span class="hljs-string">&quot;relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 rel_base&quot;</span><br><span class="hljs-keyword">gl</span> lagall <span class="hljs-string">&quot;relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11 relf_12 relf_13 relf_14 relf_15&quot;</span><br><span class="hljs-keyword">testparm</span> <span class="hljs-variable">$leadall</span> <span class="hljs-comment">//联合检验系数。此处用到了上面reghdfe回归的结果，如果在中间插入csdid，会覆盖掉</span><br><br><span class="hljs-comment">//bture指真实系数矩阵</span><br><span class="hljs-keyword">matrix</span> btrue = <span class="hljs-built_in">J</span>(1,30,.)<br><span class="hljs-keyword">matrix</span> colnames btrue = <span class="hljs-variable">$leadall</span> <span class="hljs-variable">$lagall</span><br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">l</span> = 1/14 &#123;<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`l&#x27;</span>]=0<br>&#125;<br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">h</span> = 0/15 &#123;<br>    <span class="hljs-keyword">sum</span> tauit <span class="hljs-keyword">if</span> rel_date==<span class="hljs-symbol">`h&#x27;</span>&amp;<span class="hljs-keyword">D</span>==1<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`h&#x27;</span>+15]=<span class="hljs-built_in">r</span>(<span class="hljs-keyword">mean</span>)<br>&#125;<br><span class="hljs-keyword">matrix</span> <span class="hljs-keyword">list</span> btrue<br><span class="hljs-comment">//创建一个矩阵，它的列对应于某些滞后和领先的变量，并且填充了这些变量的某些特定值（比如0或者某个分组的均值）</span><br><br>coefplot (<span class="hljs-built_in">matrix</span>(btrue[1]), <span class="hljs-built_in">m</span>(Oh)) (ES_TWFE, <span class="hljs-keyword">recast</span>(connect)), <span class="hljs-keyword">drop</span>(_cons) <span class="hljs-keyword">order</span>(relb* rel_base relf*) omitted baselevel vertical <span class="hljs-comment">///</span><br>    ciopts(<span class="hljs-keyword">recast</span>(rcap)) yline(0, lc(gs0) lp(solid)) <span class="hljs-comment">///</span><br>    xline(14.5, lc(gs8) lp(dash)) xtitle(<span class="hljs-string">&quot;相对处理发生时间&quot;</span>) ytitle(<span class="hljs-string">&quot;估计系数&quot;</span>) <span class="hljs-comment">///</span><br>    text(4 6 <span class="hljs-string">&quot;事前系数联合检验&quot;</span>, place(c)) <span class="hljs-comment">///</span><br>    text(2 6 <span class="hljs-string">&quot;F=0.83 P=0.6256&quot;</span>, place(c)) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(2 <span class="hljs-string">&quot;真实系数&quot;</span> 4 <span class="hljs-string">&quot;估计系数&quot;</span> ) <span class="hljs-variable">$brlgd</span> col(1)) <span class="hljs-comment">///</span><br>    xsize(8) scale(1.3)<br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_TWFE.png&quot;</span>, width(3000) <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_TWFE.svg&quot;</span>,  <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> <span class="hljs-keyword">save</span> figure/ES_TWFE.gph, <span class="hljs-keyword">replace</span><br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       图5        **</span><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">* 单一系数检验和联合检验</span><br><br><span class="hljs-comment">* TWFE估计</span><br><span class="hljs-keyword">gr</span> <span class="hljs-keyword">drop</span> _all <span class="hljs-comment">//删除当前图形窗口中的所有图形元素</span><br><span class="hljs-keyword">use</span> simu_data_DGP01, <span class="hljs-keyword">clear</span><br>reghdfe y relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 o.rel_base relf_*, a(id time) <span class="hljs-keyword">cluster</span>(id) <span class="hljs-comment">//这里把-1期当作基期</span><br>eststo ES_TWFE1<br><br>reghdfe y relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 o.relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 rel_base relf_*, a(id time) <span class="hljs-keyword">cluster</span>(id) <span class="hljs-comment">//这里把-8期当作基期</span><br>eststo ES_TWFE2<br><br><span class="hljs-keyword">gl</span> leadall <span class="hljs-string">&quot;relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 rel_base&quot;</span><br>coefplot ES_TWFE1 (ES_TWFE2, lp(solid)), <span class="hljs-keyword">keep</span>(<span class="hljs-variable">$leadall</span>) omitted baselevel vertical <span class="hljs-comment">///</span><br>    <span class="hljs-keyword">recast</span>(con) lw(thick) ciopts(<span class="hljs-keyword">recast</span>(rspike) color(%40)) <span class="hljs-comment">///</span><br>    yline(0, lc(gs0) lp(solid) lw(medthick)) ylab(-2(1)2) <span class="hljs-comment">///</span><br>    xtitle(<span class="hljs-string">&quot;相对处理发生时间&quot;</span>) ytitle(<span class="hljs-string">&quot;估计系数&quot;</span>)  tit(<span class="hljs-string">&quot;（a）单一系数显著性&quot;</span>, pos(6))  <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(2 <span class="hljs-string">&quot;基期 = -1&quot;</span> 4 <span class="hljs-string">&quot;基期 = -8&quot;</span>) <span class="hljs-variable">$brlgd</span>) scale(1.2)  name(PTT1)<br><br><br><span class="hljs-comment">*- 事前系数联合检验结果的不变性</span><br><span class="hljs-comment">*--- 分别以-14到-1期为基期进行回归，计算每一个回归的联合检验P值</span><br><span class="hljs-comment">*--- 结果：无论以哪一期为基期，联合检验的P值均保持不变</span><br><span class="hljs-keyword">local</span> leadall <span class="hljs-string">&quot;relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 rel_base&quot;</span><br><span class="hljs-keyword">tempvar</span> t P <br><span class="hljs-keyword">gen</span> <span class="hljs-symbol">`t&#x27;</span> = _n-15 <span class="hljs-keyword">if</span> _n&lt;=14<br><span class="hljs-keyword">gen</span> <span class="hljs-symbol">`P&#x27;</span> = .<br><span class="hljs-keyword">forvalues</span> i = 14(-1)2 &#123;<br>    <span class="hljs-keyword">local</span> base_period <span class="hljs-string">&quot;relb_`i&#x27;&quot;</span><br>    <span class="hljs-keyword">local</span> xvar: <span class="hljs-keyword">list</span> leadall - base_period<br>    reghdfe y <span class="hljs-symbol">`xvar&#x27;</span> o.<span class="hljs-symbol">`base_period&#x27;</span> relf_*, a(id time) <span class="hljs-keyword">cluster</span>(id)<br>    <span class="hljs-keyword">testparm</span> <span class="hljs-symbol">`leadall&#x27;</span><br>    <span class="hljs-keyword">replace</span> <span class="hljs-symbol">`P&#x27;</span> = <span class="hljs-built_in">r</span>(p) <span class="hljs-keyword">if</span> <span class="hljs-symbol">`t&#x27;</span>==-<span class="hljs-symbol">`i&#x27;</span><br>&#125;<br>reghdfe y <span class="hljs-symbol">`xvar&#x27;</span> o.<span class="hljs-symbol">`base_period&#x27;</span> relf_*, a(id time) <span class="hljs-keyword">cluster</span>(id)<br><span class="hljs-keyword">testparm</span> <span class="hljs-symbol">`leadall&#x27;</span><br><span class="hljs-keyword">replace</span> <span class="hljs-symbol">`P&#x27;</span> = <span class="hljs-built_in">r</span>(p) <span class="hljs-keyword">if</span> <span class="hljs-symbol">`t&#x27;</span>==-1<br><span class="hljs-keyword">sum</span> <span class="hljs-symbol">`P&#x27;</span>,<span class="hljs-keyword">d</span><br><span class="hljs-keyword">scatter</span> <span class="hljs-symbol">`P&#x27;</span> <span class="hljs-symbol">`t&#x27;</span>, c(<span class="hljs-keyword">l</span>) ylab(0(0.2)1, <span class="hljs-keyword">format</span>(%6.1f)) xlab(-14/-1) <span class="hljs-comment">///</span><br>    xtit(<span class="hljs-string">&quot;基期&quot;</span>) ytitle(<span class="hljs-string">&quot;P值&quot;</span>) tit(<span class="hljs-string">&quot;（b）联合检验显著性&quot;</span>, pos(6)) scale(1.2) name(PTT2)<br><br><span class="hljs-keyword">gr</span> combine PTT1 PTT2, xsize(10) scale(1.5)<br><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_preTest.png&quot;</span>, width(3000) <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_preTest.svg&quot;</span>,  <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> <span class="hljs-keyword">save</span> figure/ES_preTest.gph, <span class="hljs-keyword">replace</span><br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       图6        **</span><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">* 归并与截断</span><br><br><span class="hljs-comment">*** 在[-5,10]期内归并、截断</span><br><span class="hljs-keyword">use</span> simu_data_DGP01, <span class="hljs-keyword">clear</span><br><span class="hljs-keyword">cap</span> <span class="hljs-keyword">drop</span> relb_* rel_base relf_*<br><br><span class="hljs-keyword">gen</span> rel_date_cut = rel_date<br><span class="hljs-keyword">local</span> pre_cut  = 5<br><span class="hljs-keyword">local</span> post_cut = 10<br><span class="hljs-keyword">replace</span> rel_date_cut = -<span class="hljs-symbol">`pre_cut&#x27;</span>  <span class="hljs-keyword">if</span> rel_date&lt;-<span class="hljs-symbol">`pre_cut&#x27;</span><br><span class="hljs-keyword">replace</span> rel_date_cut = <span class="hljs-symbol">`post_cut&#x27;</span> <span class="hljs-keyword">if</span> rel_date&gt;<span class="hljs-symbol">`post_cut&#x27;</span><br><span class="hljs-keyword">tab</span> rel_date_cut<br><span class="hljs-comment">//把-5期之后的都改成-5，把10期之后的都改为10</span><br><br><span class="hljs-keyword">forvalues</span> k = <span class="hljs-symbol">`pre_cut&#x27;</span>(-1)2 &#123;<br>   <span class="hljs-keyword">gen</span> relb_<span class="hljs-symbol">`k&#x27;</span> = rel_date_cut == -<span class="hljs-symbol">`k&#x27;</span><br>   <span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> relb_<span class="hljs-symbol">`k&#x27;</span> <span class="hljs-string">&quot;-`k&#x27;&quot;</span><br>&#125;<br><span class="hljs-keyword">gen</span> rel_base = rel_date_cut==-1<br><span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> rel_base <span class="hljs-string">&quot;-1&quot;</span><br><span class="hljs-keyword">forvalues</span> k = 0/<span class="hljs-symbol">`post_cut&#x27;</span> &#123;<br>    <span class="hljs-keyword">gen</span> relf_<span class="hljs-symbol">`k&#x27;</span> = rel_date_cut == <span class="hljs-symbol">`k&#x27;</span><br>    <span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> relf_<span class="hljs-symbol">`k&#x27;</span> <span class="hljs-string">&quot;`k&#x27;&quot;</span><br>&#125;<br><span class="hljs-keyword">for</span> <span class="hljs-keyword">var</span> relb_* relf_* rel_base: <span class="hljs-keyword">replace</span> X = 0 <span class="hljs-keyword">if</span> group1==1 <span class="hljs-comment">// 控制组的相对数量全是0</span><br><span class="hljs-comment">//这里用了上面的局部宏，这些命令必须与上面的local等一起运行，单独运行会报错</span><br><br>reghdfe y relb_* o.rel_base relf_*, a(id time) <span class="hljs-keyword">cluster</span>(id) <span class="hljs-comment">//归并的结果</span><br>eststo ES_bin<br><br>reghdfe y relb_* o.rel_base relf_* <span class="hljs-keyword">if</span> <span class="hljs-built_in">inrange</span>(rel_date,-5,10), a(id time) <span class="hljs-keyword">cluster</span>(id) <span class="hljs-comment">//截断的话操作比较简单，直接写range就好</span><br>eststo ES_trim<br><br><span class="hljs-comment">* 设置真实系数矩阵btrue</span><br><span class="hljs-keyword">gl</span> leadall <span class="hljs-string">&quot;relb_5 relb_4 relb_3 relb_2 rel_base&quot;</span><br><span class="hljs-keyword">gl</span> lagall <span class="hljs-string">&quot;relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 &quot;</span><br><br><span class="hljs-keyword">matrix</span> btrue = <span class="hljs-built_in">J</span>(1,16,.)<br><span class="hljs-keyword">matrix</span> colnames btrue = <span class="hljs-variable">$leadall</span> <span class="hljs-variable">$lagall</span><br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">l</span> = 1/5 &#123;<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`l&#x27;</span>]=0<br>&#125;<br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">h</span> = 0/10 &#123;<br>    <span class="hljs-keyword">sum</span> tauit <span class="hljs-keyword">if</span> rel_date==<span class="hljs-symbol">`h&#x27;</span>&amp;<span class="hljs-keyword">D</span>==1<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`h&#x27;</span>+6]=<span class="hljs-built_in">r</span>(<span class="hljs-keyword">mean</span>)<br>&#125;<br><span class="hljs-keyword">matrix</span> <span class="hljs-keyword">list</span> btrue<br><br>coefplot (<span class="hljs-built_in">matrix</span>(btrue[1]), <span class="hljs-built_in">m</span>(Oh)) ES_bin ES_trim, <span class="hljs-keyword">drop</span>(_cons) <span class="hljs-keyword">order</span>(relb* rel_base relf*) omitted baselevel vertical  <span class="hljs-comment">///</span><br>    ciopts(<span class="hljs-keyword">recast</span>(rcap)) yline(0, lc(gs0) lp(solid)) <span class="hljs-comment">///</span><br>    xline(5.5, lc(gs8) lp(dash)) xtitle(<span class="hljs-string">&quot;相对处理时期&quot;</span>) ytitle(<span class="hljs-string">&quot;估计系数&quot;</span>) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(2 <span class="hljs-string">&quot;真实系数&quot;</span> 4 <span class="hljs-string">&quot;归并样本 (binned)&quot;</span> 6 <span class="hljs-string">&quot;截断样本 (trimmed)&quot;</span>) <span class="hljs-variable">$blgd</span>) <span class="hljs-comment">///</span><br>    title(<span class="hljs-string">&quot;（a）事件窗口期[-5,10]&quot;</span>, pos(6)) name(BT1)<br><br><br><span class="hljs-comment">***在[-10,5]期内归并、截断</span><br><span class="hljs-keyword">use</span> simu_data_DGP01, <span class="hljs-keyword">clear</span><br><span class="hljs-keyword">cap</span> <span class="hljs-keyword">drop</span> relb_* rel_base relf_*<br><br><span class="hljs-keyword">gen</span> rel_date_cut = rel_date<br><span class="hljs-keyword">local</span> pre_cut  = 10<br><span class="hljs-keyword">local</span> post_cut = 5<br><span class="hljs-keyword">replace</span> rel_date_cut = -<span class="hljs-symbol">`pre_cut&#x27;</span>  <span class="hljs-keyword">if</span> rel_date&lt;-<span class="hljs-symbol">`pre_cut&#x27;</span><br><span class="hljs-keyword">replace</span> rel_date_cut = <span class="hljs-symbol">`post_cut&#x27;</span> <span class="hljs-keyword">if</span> rel_date&gt;<span class="hljs-symbol">`post_cut&#x27;</span><br><span class="hljs-keyword">tab</span> rel_date_cut<br><br><span class="hljs-keyword">forvalues</span> k = <span class="hljs-symbol">`pre_cut&#x27;</span>(-1)2 &#123;<br>   <span class="hljs-keyword">gen</span> relb_<span class="hljs-symbol">`k&#x27;</span> = rel_date_cut == -<span class="hljs-symbol">`k&#x27;</span><br>   <span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> relb_<span class="hljs-symbol">`k&#x27;</span> <span class="hljs-string">&quot;-`k&#x27;&quot;</span><br>&#125;<br><span class="hljs-keyword">gen</span> rel_base = rel_date_cut==-1<br><span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> rel_base <span class="hljs-string">&quot;-1&quot;</span><br><span class="hljs-keyword">forvalues</span> k = 0/<span class="hljs-symbol">`post_cut&#x27;</span> &#123;<br>    <span class="hljs-keyword">gen</span> relf_<span class="hljs-symbol">`k&#x27;</span> = rel_date_cut == <span class="hljs-symbol">`k&#x27;</span><br>    <span class="hljs-keyword">label</span> <span class="hljs-keyword">var</span> relf_<span class="hljs-symbol">`k&#x27;</span> <span class="hljs-string">&quot;`k&#x27;&quot;</span><br>&#125;<br><span class="hljs-keyword">for</span> <span class="hljs-keyword">var</span> relb_* relf_* rel_base: <span class="hljs-keyword">replace</span> X = 0 <span class="hljs-keyword">if</span> group1==1 <span class="hljs-comment">// 控制组的相对数量全是0</span><br>reghdfe y relb_* o.rel_base relf_*, a(id time) <span class="hljs-keyword">cluster</span>(id)<br>eststo ES_bin<br><br>reghdfe y relb_* o.rel_base relf_* <span class="hljs-keyword">if</span> <span class="hljs-built_in">inrange</span>(rel_date,-10,5), a(id time) <span class="hljs-keyword">cluster</span>(id)<br>eststo ES_trim<br><br><span class="hljs-keyword">gl</span> leadall <span class="hljs-string">&quot;relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 rel_base&quot;</span><br><span class="hljs-keyword">gl</span> lagall <span class="hljs-string">&quot;relf_0 relf_1 relf_2 relf_3 relf_4 relf_5&quot;</span><br><span class="hljs-keyword">matrix</span> btrue = <span class="hljs-built_in">J</span>(1,16,.)<br><span class="hljs-keyword">matrix</span> colnames btrue = <span class="hljs-variable">$leadall</span> <span class="hljs-variable">$lagall</span><br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">l</span> = 1/10 &#123;<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`l&#x27;</span>]=0<br>&#125;<br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">h</span> = 0/5 &#123;<br>    <span class="hljs-keyword">sum</span> tauit <span class="hljs-keyword">if</span> rel_date==<span class="hljs-symbol">`h&#x27;</span>&amp;<span class="hljs-keyword">D</span>==1<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`h&#x27;</span>+11]=<span class="hljs-built_in">r</span>(<span class="hljs-keyword">mean</span>)<br>&#125;<br><span class="hljs-keyword">matrix</span> <span class="hljs-keyword">list</span> btrue<br><br>coefplot (<span class="hljs-built_in">matrix</span>(btrue[1]), <span class="hljs-built_in">m</span>(Oh)) ES_bin ES_trim, <span class="hljs-keyword">drop</span>(_cons) <span class="hljs-keyword">order</span>(relb* rel_base relf*) omitted baselevel vertical <span class="hljs-comment">///</span><br>    ciopts(<span class="hljs-keyword">recast</span>(rcap)) yline(0, lc(gs0) lp(solid)) <span class="hljs-comment">///</span><br>    xline(10.5, lc(gs8) lp(dash)) ylabel(0(3)9) xtitle(<span class="hljs-string">&quot;相对处理时期&quot;</span>) ytitle(<span class="hljs-string">&quot;估计系数&quot;</span>) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(2 <span class="hljs-string">&quot;真实系数&quot;</span> 4 <span class="hljs-string">&quot;归并样本 (binned)&quot;</span> 6 <span class="hljs-string">&quot;截断样本 (trimmed)&quot;</span>) <span class="hljs-variable">$blgd</span>) <span class="hljs-comment">///</span><br>    title(<span class="hljs-string">&quot;（b）事件窗口期[-10,5]&quot;</span>, pos(6)) name(BT2)<br><br>grc1leg2 BT1 BT2, xsize(10) scale(1.5) labsize(small)<br><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_BinTrim.png&quot;</span>, width(3000) <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_BinTrim.svg&quot;</span>, <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> <span class="hljs-keyword">save</span> figure/ES_BinTrim.gph, <span class="hljs-keyword">replace</span><br></code></pre></td></tr></table></figure>

<h3 id="3-3-存在组群时间趋势的情况"><a href="#3-3-存在组群时间趋势的情况" class="headerlink" title="3.3 存在组群时间趋势的情况"></a>3.3 存在组群时间趋势的情况</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">clear</span> all<br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       图7        **</span><br><span class="hljs-comment">**********************</span><br><span class="hljs-keyword">use</span> simu_data_DGP02, <span class="hljs-keyword">clear</span><br><br><span class="hljs-keyword">cap</span> <span class="hljs-keyword">gr</span> <span class="hljs-keyword">drop</span> GT* <span class="hljs-comment">//这行代码尝试删除所有以 &quot;GT&quot; 开头的图形对象，并且即使没有找到这样命名的图形对象也不会显示错误信息，整个程序会继续执行下去。这通常用于编写脚本时，确保即使某些图形对象不存在时脚本也可以继续无误地运行。</span><br><span class="hljs-keyword">preserve</span> <br><span class="hljs-keyword">collapse</span> (<span class="hljs-keyword">mean</span>) y, <span class="hljs-keyword">by</span>(treat time)<br><span class="hljs-keyword">tw</span>  (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==2, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(o) lp(solid)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==3, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(s) lp(solid)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==4, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(t) lp(solid)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==1, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(<span class="hljs-keyword">d</span>) lp(solid)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">lfit</span> y time <span class="hljs-keyword">if</span> treat==2&amp;time&lt;5, <span class="hljs-keyword">range</span>(1 20) lc(plb1) lp(shortdash)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">lfit</span> y time <span class="hljs-keyword">if</span> treat==3&amp;time&lt;10, <span class="hljs-keyword">range</span>(1 20) lc(plr1) lp(shortdash)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">lfit</span> y time <span class="hljs-keyword">if</span> treat==4&amp;time&lt;15, <span class="hljs-keyword">range</span>(1 20) lc(plg1) lp(shortdash)) , ylabel(0(10)50) <span class="hljs-comment">///</span><br>    xtitle(<span class="hljs-string">&quot;时期&quot;</span>) ytitle(<span class="hljs-string">&quot;结果变量Y&quot;</span>) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;组群1（趋势=1t）&quot;</span> 2 <span class="hljs-string">&quot;组群2（趋势=0.5t）&quot;</span> 3 <span class="hljs-string">&quot;组群3（趋势=0.2t）&quot;</span> 4 <span class="hljs-string">&quot;控制组&quot;</span>) <span class="hljs-variable">$blgd</span> col(2)) <span class="hljs-comment">///</span><br>    tit(<span class="hljs-string">&quot;（a）模拟数据&quot;</span>, pos(6)) scale(1.2) name(GT_data1)<br><span class="hljs-keyword">restore</span><br><br><span class="hljs-keyword">preserve</span> <br>    reghdfe y <span class="hljs-keyword">if</span> <span class="hljs-keyword">D</span>==0, a(id time groupFE=i.treat#c.time) <span class="hljs-keyword">cluster</span>(id) <span class="hljs-comment">//仅回归全部处理前的情况，还固定了组群与时间的交互项</span><br>    ereplace groupFESlope1 = <span class="hljs-keyword">mean</span>(groupFESlope1), <span class="hljs-keyword">by</span>(id) <span class="hljs-comment">//将每个 id 分组内的 groupFESlope1 替换为该分组内 groupFESlope1 的均值。这实际上是在执行一个分组内的均值归一化。就是把那些D=1的观测值也填上上面计算的结果。groupFESlope1其实就是斜率？</span><br>    <span class="hljs-keyword">gen</span> grouptrend = time*groupFESlope1 <span class="hljs-comment">//得到时间趋势</span><br>    <span class="hljs-keyword">gen</span> y_hat = y - grouptrend <span class="hljs-comment">//去除时间趋势</span><br>    <span class="hljs-keyword">collapse</span> (<span class="hljs-keyword">mean</span>) y_hat, <span class="hljs-keyword">by</span>(treat time)<br>    <span class="hljs-keyword">tw</span>  (<span class="hljs-keyword">sc</span> y_hat time <span class="hljs-keyword">if</span> treat==2, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(oh) lp(dash)) <span class="hljs-comment">///</span><br>        (<span class="hljs-keyword">sc</span> y_hat time <span class="hljs-keyword">if</span> treat==3, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(<span class="hljs-keyword">sh</span>) lp(dash)) <span class="hljs-comment">///</span><br>        (<span class="hljs-keyword">sc</span> y_hat time <span class="hljs-keyword">if</span> treat==4, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(th) lp(dash)) <span class="hljs-comment">///</span><br>        (<span class="hljs-keyword">sc</span> y_hat time <span class="hljs-keyword">if</span> treat==1, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(dh) lp(dash)), ylabel(0(10)35) <span class="hljs-comment">///</span><br>        xtitle(<span class="hljs-string">&quot;时期&quot;</span>) ytitle(<span class="hljs-string">&quot;结果变量Y&quot;</span>) legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;组群1&quot;</span> 2 <span class="hljs-string">&quot;组群2 (T*=10, 趋势=0.5t)&quot;</span> 3 <span class="hljs-string">&quot;组群3 (T*=15, 趋势=0.2t)&quot;</span> 4 <span class="hljs-string">&quot;控制组&quot;</span>) <span class="hljs-variable">$blgd</span> row(2)) <span class="hljs-comment">///</span><br>        tit(<span class="hljs-string">&quot;（b）剔除时间趋势&quot;</span>, pos(6)) scale(1.2) name(GT_data2)<br><span class="hljs-keyword">restore</span><br><br>grc1leg2 GT_data1 GT_data2, xsize(10) scale(1.3)  lr(1) labsize(small)<br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_GTdata.png&quot;</span>, width(3000) <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_GTdata.svg&quot;</span>, <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> <span class="hljs-keyword">save</span> figure/ES_GTdata.gph, <span class="hljs-keyword">replace</span><br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       图8        **</span><br><span class="hljs-comment">**********************</span><br><span class="hljs-keyword">use</span> simu_data_DGP02, <span class="hljs-keyword">clear</span><br><br>reghdfe y relb_* o.rel_base relf_*, a(id time) <span class="hljs-keyword">cluster</span>(id) <span class="hljs-comment">//直接回归，不控制组群时间趋势，结果很奇怪，处理前后都显著，尽管处理前系数绝对值不大</span><br>eststo TWFE<br><br>reghdfe y  relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 o.rel_base relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11 relf_12 relf_13 relf_14 relf_15, a(id time i.treat#c.time) <span class="hljs-keyword">cluster</span>(id) <span class="hljs-comment">//控制了组群时间趋势，处理前系数为负，且绝对值很大，此后绝对值一路转小，到处理后期不显著了</span><br>eststo TWFE_wtrend<br><br><span class="hljs-keyword">gl</span> leadall <span class="hljs-string">&quot;relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 rel_base&quot;</span><br><span class="hljs-keyword">gl</span> lagall <span class="hljs-string">&quot;relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11 relf_12 relf_13 relf_14 relf_15&quot;</span><br><span class="hljs-keyword">gl</span> lead10 <span class="hljs-string">&quot;relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 rel_base&quot;</span><br><span class="hljs-keyword">gl</span> lag10 <span class="hljs-string">&quot;relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10&quot;</span><br><br><span class="hljs-keyword">matrix</span> btrue = <span class="hljs-built_in">J</span>(1,30,.)<br><span class="hljs-keyword">matrix</span> colnames btrue = <span class="hljs-variable">$leadall</span> <span class="hljs-variable">$lagall</span><br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">l</span> = 1/14 &#123;<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`l&#x27;</span>]=0<br>&#125;<br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">h</span> = 0/15 &#123;<br>    <span class="hljs-keyword">sum</span> tauit <span class="hljs-keyword">if</span> rel_date==<span class="hljs-symbol">`h&#x27;</span>&amp;<span class="hljs-keyword">D</span>==1<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`h&#x27;</span>+15]=<span class="hljs-built_in">r</span>(<span class="hljs-keyword">mean</span>)<br>&#125;<br><span class="hljs-keyword">matrix</span> <span class="hljs-keyword">list</span> btrue<br><br><span class="hljs-keyword">cap</span> <span class="hljs-keyword">gr</span> <span class="hljs-keyword">drop</span> GT_est*<br>coefplot (<span class="hljs-built_in">matrix</span>(btrue[1]), msym(Oh)) TWFE TWFE_wtrend, <span class="hljs-keyword">keep</span>(<span class="hljs-variable">$lead10</span> <span class="hljs-variable">$lag10</span>) <span class="hljs-keyword">order</span>(<span class="hljs-variable">$lead10</span> <span class="hljs-variable">$lag10</span>) omitted baselevel vertical nooffsets <span class="hljs-comment">///</span><br>    <span class="hljs-keyword">recast</span>(connect) ciopts(<span class="hljs-keyword">recast</span>(rcap)) yline(0, lc(gs8) lp(solid)) <span class="hljs-comment">///</span><br>    xline(10.5, lc(gs8) lp(dash)) xtitle(<span class="hljs-string">&quot;相对处理时期&quot;</span>) ytitle(<span class="hljs-string">&quot;估计系数&quot;</span>) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(2 <span class="hljs-string">&quot;真实系数&quot;</span> 4 <span class="hljs-string">&quot;事件研究法&quot;</span> 6 <span class="hljs-string">&quot;控制组别时间趋势&quot;</span>) <span class="hljs-variable">$blgd</span> col(3)) <span class="hljs-comment">///</span><br>    tit(<span class="hljs-string">&quot;（a）控制组别时间趋势&quot;</span>, pos(6)) scale(1.2) name(GT_est1)<br><br><span class="hljs-keyword">est</span> <span class="hljs-keyword">clear</span><br>reghdfe y  relb_14 relb_13 relb_12 relb_11 o.relb_10 relb_9 relb_8 relb_7 relb_6 o.relb_5 relb_4 relb_3 relb_2 rel_base relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11 relf_12 relf_13 relf_14 relf_15, a(id time i.treat#c.time) <span class="hljs-keyword">cluster</span>(id)<br>eststo TWFE_wtrend1<br><span class="hljs-comment">//基期是-10、-5，控制了组群时间趋势，此时的结果与真实系数相差不大。其实只要包含最早的基期和处理前一期，控制时间趋势的话，结果相差不大的，在置信区间内</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">reghdfe y  o.relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 o.rel_base relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11 relf_12 relf_13 relf_14 relf_15, a(id time i.treat#c.time ) cluster(id) //比如这里，基期是-14和-1，此时的结果与真实系数很接近，且真实系数在估计结果的置信区间内，因此，控制时间趋势并且正确选择基期，是可以得到有效估计的。或者把事前全部omitted也行。不过这对正确把握现实中的冲击生效时间很重要。</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br>reghdfe y  relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 o.rel_base relf_0 relf_1 relf_2 relf_3 relf_4 o.relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11 relf_12 relf_13 relf_14 relf_15, a(id time i.treat#c.time) <span class="hljs-keyword">cluster</span>(id) <span class="hljs-comment">//基期是-1、5，也控制了组群时间趋势，此时的结果与真实系数差得离谱</span><br>eststo TWFE_wtrend2<br><br>coefplot (<span class="hljs-built_in">matrix</span>(btrue[1]), msym(Oh)) TWFE_wtrend1 TWFE_wtrend2, <span class="hljs-keyword">keep</span>(<span class="hljs-variable">$lead10</span> <span class="hljs-variable">$lag10</span>) <span class="hljs-keyword">order</span>(<span class="hljs-variable">$lead10</span> <span class="hljs-variable">$lag10</span>) omitted baselevel vertical <span class="hljs-keyword">recast</span>(con) <span class="hljs-comment">///</span><br>    ciopts(<span class="hljs-keyword">recast</span>(rcap)) yline(0, lc(gs8) lp(solid)) <span class="hljs-comment">///</span><br>    xline(14.5, lc(gs8) lp(dash)) xtitle(<span class="hljs-string">&quot;相对处理时期&quot;</span>) ytitle(<span class="hljs-string">&quot;估计系数&quot;</span>) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(2 <span class="hljs-string">&quot;真实系数&quot;</span> 4 <span class="hljs-string">&quot;基期=(-10, -5)&quot;</span> 6 <span class="hljs-string">&quot;基期=(-1, 5)&quot;</span>) <span class="hljs-variable">$blgd</span> col(3)) <span class="hljs-comment">///</span><br>    tit(<span class="hljs-string">&quot;（b）更换基期&quot;</span>, pos(6)) scale(1.2) name(GT_est2)<br><br><span class="hljs-keyword">gr</span> combine GT_est1 GT_est2, xsize(10) scale(1.3)<br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_GTest.png&quot;</span>, width(3000) <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_GTest.svg&quot;</span>, <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> <span class="hljs-keyword">save</span> figure/ES_GTest.gph, <span class="hljs-keyword">replace</span><br><br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       表1        **</span><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">* 组别时间趋势系数估计</span><br><span class="hljs-keyword">use</span> simu_data_DGP02, <span class="hljs-keyword">clear</span><br><span class="hljs-keyword">forvalues</span> i = 1/4&#123;<br>    <span class="hljs-keyword">gen</span> group<span class="hljs-symbol">`i&#x27;</span>_time = (treat==<span class="hljs-symbol">`i&#x27;</span>) * time<br>&#125;<br><span class="hljs-comment">* 由于组别时间趋势与时间固定效应共线，故以时间趋势为0的控制组（group1）为参照组</span><br><span class="hljs-comment">* 系数代表各组群的线性时间趋势系数与参照组的差异，由于参照组本身无时间趋势，故系数代表各组本身的线性时间趋势斜率</span><br><span class="hljs-keyword">est</span> <span class="hljs-keyword">clear</span><br>reghdfe y group2_time group3_time group4_time, a(id time) <span class="hljs-keyword">cluster</span>(id) <span class="hljs-comment">//使用全样本估计时间趋势，此时是不准确的</span><br>eststo model_aux1<br>reghdfe y group2_time group3_time group4_time <span class="hljs-keyword">if</span> <span class="hljs-keyword">D</span>==0, a(id time) <span class="hljs-keyword">cluster</span>(id) <span class="hljs-comment">//使用未处理样本，即D=0的样本，估计时间趋势，此时是准确的</span><br>eststo model_aux2<br>esttab model_aux2 model_aux1, <span class="hljs-keyword">keep</span>(group*) r2 <span class="hljs-keyword">se</span> b(4) star(* 0.10 ** 0.05 *** 0.01) <br><span class="hljs-comment">/*------------------------------------------</span><br><span class="hljs-comment">                      (1)             (2)   </span><br><span class="hljs-comment">                        y               y   </span><br><span class="hljs-comment">--------------------------------------------</span><br><span class="hljs-comment">group2_time        1.0421***       1.9330***</span><br><span class="hljs-comment">                 (0.1556)        (0.0170)   </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">group3_time        0.5090***       1.1024***</span><br><span class="hljs-comment">                 (0.0471)        (0.0168)   </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">group4_time        0.2375***       0.4470***</span><br><span class="hljs-comment">                 (0.0276)        (0.0173)   </span><br><span class="hljs-comment">--------------------------------------------</span><br><span class="hljs-comment">N                    4700            8000   </span><br><span class="hljs-comment">R-sq                0.785           0.953   </span><br><span class="hljs-comment">--------------------------------------------*/</span><br><span class="hljs-comment">* esttab model_aux2 model_aux1 using &quot;table\model_aux.rtf&quot;, keep(group*) r2 se b(4) star(* 0.10 ** 0.05 *** 0.01) nogap replace //导出结果</span><br><br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       图9        **</span><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">* 正确控制组间时间趋势</span><br><span class="hljs-comment">*   - detrend</span><br><span class="hljs-comment">*   - imputation</span><br><br><span class="hljs-keyword">use</span> simu_data_DGP02, <span class="hljs-keyword">clear</span><br><span class="hljs-keyword">gl</span> leadall <span class="hljs-string">&quot;relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 rel_base&quot;</span><br><span class="hljs-keyword">gl</span> lagall <span class="hljs-string">&quot;relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11 relf_12 relf_13 relf_14 relf_15&quot;</span><br><br><span class="hljs-comment">*- True ATT</span><br><span class="hljs-keyword">matrix</span> btrue = <span class="hljs-built_in">J</span>(1,30,.)<br><span class="hljs-keyword">matrix</span> colnames btrue = <span class="hljs-variable">$leadall</span> <span class="hljs-variable">$lagall</span><br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">l</span> = 1/14 &#123;<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`l&#x27;</span>]=0<br>&#125;<br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">h</span> = 0/15 &#123;<br>    <span class="hljs-keyword">sum</span> tauit <span class="hljs-keyword">if</span> rel_date==<span class="hljs-symbol">`h&#x27;</span>&amp;<span class="hljs-keyword">D</span>==1<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`h&#x27;</span>+15]=<span class="hljs-built_in">r</span>(<span class="hljs-keyword">mean</span>)<br>&#125;<br><span class="hljs-keyword">matrix</span> <span class="hljs-keyword">list</span> btrue<br><span class="hljs-comment">//真实的处理效果就是，-1期及之前都是0，之后每期+1</span><br><br><span class="hljs-comment">*- TWFE event study</span><br>reghdfe y relb_* o.rel_base relf_*, a(id time) <span class="hljs-keyword">cluster</span>(id) <span class="hljs-comment">//这里只选择了-1期做基期，是有偏的</span><br>eststo TWFE_trend<br><br><span class="hljs-comment">*- Detrend (Good-man Bacon, 2021)</span><br>reghdfe y <span class="hljs-keyword">if</span> <span class="hljs-keyword">D</span>==0, a(id time groupFE=i.treat#c.time) <span class="hljs-keyword">cluster</span>(id)<br>ereplace groupFESlope1 = <span class="hljs-keyword">mean</span>(groupFESlope1), <span class="hljs-keyword">by</span>(id)<br><span class="hljs-keyword">gen</span> grouptrend = time*groupFESlope1<br><span class="hljs-keyword">gen</span> y_hat = y - grouptrend <span class="hljs-comment">//减去了时间趋势</span><br>reghdfe y_hat relb_* o.rel_base relf_*, a(id time) <span class="hljs-keyword">cluster</span>(id)<br>eststo TWFE_detrend<br><br><span class="hljs-comment">*- Generalized SCM (Liu et al., 2021)</span><br><span class="hljs-keyword">forvalues</span> i = 1/4&#123;<br>    <span class="hljs-keyword">gen</span> group<span class="hljs-symbol">`i&#x27;</span>_time = (treat==<span class="hljs-symbol">`i&#x27;</span>) * time<br>&#125;<br>fect y, treat(<span class="hljs-keyword">D</span>) unit(id) time(time) cov(group1_time group2_time group3_time group4_time) method(<span class="hljs-string">&quot;fe&quot;</span>) <span class="hljs-keyword">se</span> nboots(100) <span class="hljs-comment">//广义合成控制的结果，也是准确的，怎么感觉这个方法本质上跟去除时间趋势是一样的</span><br><span class="hljs-keyword">matrix</span> fect_results = <span class="hljs-built_in">e</span>(ATTs)<br><span class="hljs-keyword">matrix</span> rownames fect_results = relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 relb_1 relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11<br><span class="hljs-keyword">matrix</span> fect_b = fect_results[4..24,3]  <span class="hljs-comment">//storing the estimates for later</span><br><span class="hljs-keyword">matrix</span> fect_v = fect_results[4..24,4]<br><span class="hljs-keyword">matrix</span> fect = [fect_b , fect_v]&#x27;<br><br><span class="hljs-comment">*- Two-stage DiD (Gardner, 2021)</span><br>did2s y, first_stage(i.id i.time i.treat#c.time) second_stage(relb* rel_base relf*) treatment(<span class="hljs-keyword">D</span>) <span class="hljs-keyword">cluster</span>(id)<br>eststo twostage <span class="hljs-comment">//两阶段DID的结果最准确，但是居然不用drop掉一期？？</span><br><br><span class="hljs-keyword">gl</span> lead10 <span class="hljs-string">&quot;relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 rel_base&quot;</span><br><span class="hljs-keyword">gl</span> lag10 <span class="hljs-string">&quot;relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10&quot;</span><br>coefplot (<span class="hljs-built_in">matrix</span>(btrue[1]), msym(Oh) <span class="hljs-keyword">recast</span>(<span class="hljs-keyword">scatter</span>))  <span class="hljs-comment">///</span><br>         (TWFE_trend, <span class="hljs-built_in">m</span>(t)) <span class="hljs-comment">///</span><br>         (TWFE_detrend, <span class="hljs-built_in">m</span>(s)) <span class="hljs-comment">///</span><br>         (twostage, <span class="hljs-built_in">m</span>(<span class="hljs-keyword">d</span>)) <span class="hljs-comment">///</span><br>         (<span class="hljs-built_in">matrix</span>(fect[1]), <span class="hljs-keyword">se</span>(2) <span class="hljs-built_in">m</span>(X)), <span class="hljs-comment">///</span><br>         <span class="hljs-keyword">keep</span>(<span class="hljs-variable">$lead10</span> <span class="hljs-variable">$lag10</span>) omitted baselevel vertical <span class="hljs-comment">///</span><br>         ciopts(<span class="hljs-keyword">recast</span>(rspike)) yline(0, lc(gs8) lp(solid)) <span class="hljs-comment">///</span><br>         xline(10.5, lc(gs8) lp(dash)) xtitle(<span class="hljs-string">&quot;相对处理时期&quot;</span>) ytitle(<span class="hljs-string">&quot;估计系数&quot;</span>) <span class="hljs-comment">///</span><br>         legend(<span class="hljs-keyword">order</span>(2 <span class="hljs-string">&quot;真实系数&quot;</span> 4 <span class="hljs-string">&quot;事件研究法（TWFE）&quot;</span> 6 <span class="hljs-string">&quot;去事前趋势（Goodman-Bacon, 2021）&quot;</span> 8 <span class="hljs-string">&quot;两阶段DiD （Gardner, 2022）&quot;</span> 10 <span class="hljs-string">&quot;广义合成控制法 （Liu等, 2022）&quot;</span>) <span class="hljs-variable">$tllgd</span> col(1)) <span class="hljs-comment">///</span><br>         xsize(8)  scale(1.3) <br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_GTest3.png&quot;</span>, width(3000) <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_GTest3.svg&quot;</span>, <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> <span class="hljs-keyword">save</span> figure/ES_GTest3.gph, <span class="hljs-keyword">replace</span><br><br><br><span class="hljs-comment">/*** 错误控制组间趋势的影响</span><br><span class="hljs-comment">use simu_data_DGP01, clear //导入不存在组间趋势差异的数据</span><br><span class="hljs-comment">est clear</span><br><span class="hljs-comment">reghdfe y relb_* o.rel_base relf_*, a(id time) cluster(id)</span><br><span class="hljs-comment">eststo TWFE</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">reghdfe y relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 o.relb_5 relb_4 relb_3 relb_2 o.rel_base relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11 relf_12 relf_13 relf_14 relf_15, a(id time i.treat##c.time) cluster(id)</span><br><span class="hljs-comment">eststo TWFE_wtrend1</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">reghdfe y relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 o.rel_base relf_0 relf_1 relf_2 relf_3 relf_4 o.relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11 relf_12 relf_13 relf_14 relf_15, a(id time i.treat##c.time) cluster(id)</span><br><span class="hljs-comment">eststo TWFE_wtrend2</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">matrix btrue = J(1,30,.)</span><br><span class="hljs-comment">matrix colnames btrue = $leadall $lagall</span><br><span class="hljs-comment">qui forvalues l = 1/14 &#123;</span><br><span class="hljs-comment">    matrix btrue[1,`l&#x27;]=0</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">qui forvalues h = 0/15 &#123;</span><br><span class="hljs-comment">    sum tauit if rel_date==`h&#x27;&amp;D==1</span><br><span class="hljs-comment">    matrix btrue[1,`h&#x27;+15]=r(mean)</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">matrix list btrue</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">coefplot (matrix(btrue[1]), msym(Oh)) TWFE_wtrend1 TWFE_wtrend2, keep($leadall $lagall) order($leadall $lagall) omitted baselevel vertical ///</span><br><span class="hljs-comment">    ciopts(recast(rcap)) yline(0, lc(gs8) lp(solid)) ///</span><br><span class="hljs-comment">    xline(14.5, lc(gs8) lp(dash)) xtitle(&quot;相对处理时期&quot;) ytitle(&quot;估计系数&quot;) ///</span><br><span class="hljs-comment">    legend(order(2 &quot;真实系数&quot; 4 &quot;基期=（-5, -1）&quot; 6 &quot;基期=（-1, 5）&quot;) $blgd col(3)) xsize(8) scale(1.2)</span><br></code></pre></td></tr></table></figure>

<h4 id="3-4-存在异质性处理效应的情况"><a href="#3-4-存在异质性处理效应的情况" class="headerlink" title="3.4 存在异质性处理效应的情况"></a>3.4 存在异质性处理效应的情况</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">clear</span> all<br><br><span class="hljs-comment">* 设定glolab</span><br><span class="hljs-keyword">gl</span> leadall <span class="hljs-string">&quot;relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 rel_base&quot;</span> <span class="hljs-comment">// 事前全部系数</span><br><span class="hljs-keyword">gl</span> lagall <span class="hljs-string">&quot;relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11 relf_12 relf_13 relf_14 relf_15&quot;</span> <span class="hljs-comment">// 事后全部系数</span><br><span class="hljs-keyword">gl</span> lead10 <span class="hljs-string">&quot;relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 rel_base&quot;</span> <span class="hljs-comment">// 事前10期系数</span><br><span class="hljs-keyword">gl</span> lag10 <span class="hljs-string">&quot;relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10&quot;</span> <span class="hljs-comment">// 事后10期系数</span><br><br><span class="hljs-comment">***********************</span><br><span class="hljs-comment">**   1.观察原始数据    **</span><br><span class="hljs-comment">***********************</span><br><span class="hljs-keyword">use</span> simu_data_DGP03, <span class="hljs-keyword">clear</span><br><br><span class="hljs-keyword">preserve</span> <br><span class="hljs-keyword">collapse</span> (<span class="hljs-keyword">mean</span>) y, <span class="hljs-keyword">by</span>(treat time)<br><span class="hljs-keyword">tw</span>  (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==2, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(O)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==3, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(S)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==4, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(T)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==1, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(<span class="hljs-keyword">D</span>)), ylabel(0(10)30) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;组群1 (T*=  5, ATT&#123;sub:t&#125;=0.5t)&quot;</span> 2 <span class="hljs-string">&quot;组群2 (T*=10, ATT&#123;sub:t&#125;=1t)&quot;</span> 3 <span class="hljs-string">&quot;组群3 (T*=15, ATT&#123;sub:t&#125;=2t)&quot;</span> 4 <span class="hljs-string">&quot;控制组&quot;</span> ) <span class="hljs-variable">$blgd</span> col(2)) xtitle(<span class="hljs-string">&quot;时期&quot;</span>) ytitle(<span class="hljs-string">&quot;结果变量Y&quot;</span>) name(HTdata1)<br><span class="hljs-keyword">restore</span><br><br><span class="hljs-keyword">preserve</span> <br><span class="hljs-keyword">collapse</span> (<span class="hljs-keyword">mean</span>) tauit, <span class="hljs-keyword">by</span>(treat rel_date)<br><span class="hljs-keyword">tw</span>  (<span class="hljs-keyword">sc</span> tauit rel_date <span class="hljs-keyword">if</span> treat==2, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(s)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> tauit rel_date <span class="hljs-keyword">if</span> treat==3, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(t)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> tauit rel_date <span class="hljs-keyword">if</span> treat==4, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(<span class="hljs-keyword">d</span>)), xlabel(-15(5)15) <span class="hljs-comment">///</span><br>    xtitle(<span class="hljs-string">&quot;相对处理时期&quot;</span>) ytitle(<span class="hljs-string">&quot;平均处理效应 (ATT)&quot;</span>) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;组群1 (T*=  5, ATT&#123;sub:t&#125;=0.5t)&quot;</span> 2 <span class="hljs-string">&quot;组群2 (T*=10, ATT&#123;sub:t&#125;=1t)&quot;</span> 3 <span class="hljs-string">&quot;组群3 (T*=15, ATT&#123;sub:t&#125;=2t)&quot;</span>) <span class="hljs-variable">$blgd</span> col(2)) name(HTdata2)<br><span class="hljs-keyword">restore</span><br><br><span class="hljs-keyword">gr</span> combine HTdata1 HTdata2, xsize(10) scale(1.5)<br><br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       图10       **</span><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">* Sun &amp; Abraham(2021)权重分解</span><br><span class="hljs-comment">*   - 手动进行S&amp;A的权重分解</span><br><span class="hljs-comment">*   - 全部权重结果输出在weightfiles.xlsx文件中</span><br><span class="hljs-comment">*   - 基期为-1期</span><br><span class="hljs-keyword">use</span> simu_data_DGP03, <span class="hljs-keyword">clear</span><br><span class="hljs-keyword">local</span> b_idc <span class="hljs-string">&quot;relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11 relf_12 relf_13 relf_14 relf_15&quot;</span><br><span class="hljs-comment">* prepare partial out</span><br>hdfe <span class="hljs-symbol">`b_idc&#x27;</span>, absorb(id time) <span class="hljs-keyword">generate</span>(res_)<br><span class="hljs-keyword">levelsof</span> timing, <span class="hljs-keyword">local</span>(cohort_list) <span class="hljs-comment">// missing cohort includes the never treated units</span><br><span class="hljs-keyword">levelsof</span> rel_date, <span class="hljs-keyword">local</span>(rel_time_list) <br><span class="hljs-comment">* Loop over cohort and relative times</span><br><span class="hljs-keyword">tempname</span> bb bb_w<br><span class="hljs-keyword">foreach</span> yy of <span class="hljs-keyword">local</span> cohort_list &#123;<br>    <span class="hljs-keyword">foreach</span> rr of <span class="hljs-keyword">local</span> rel_time_list &#123; <br>    <span class="hljs-keyword">tempvar</span> catt<br>        <span class="hljs-keyword">qui</span> <span class="hljs-keyword">count</span> <span class="hljs-keyword">if</span> timing == <span class="hljs-symbol">`yy&#x27;</span> &amp; rel_date == <span class="hljs-symbol">`rr&#x27;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">r</span>(<span class="hljs-keyword">N</span>) &gt;0 &#123;<br>            <span class="hljs-keyword">qui</span> <span class="hljs-keyword">gen</span> <span class="hljs-symbol">`catt&#x27;</span>  = (timing == <span class="hljs-symbol">`yy&#x27;</span>) * (rel_date == <span class="hljs-symbol">`rr&#x27;</span>)<br>            <span class="hljs-keyword">qui</span> <span class="hljs-keyword">regress</span> <span class="hljs-symbol">`catt&#x27;</span> res_*, nocons<br>            <span class="hljs-keyword">mat</span> <span class="hljs-symbol">`bb_w&#x27;</span> = <span class="hljs-built_in">e</span>(b)<br>            <span class="hljs-keyword">mat</span> <span class="hljs-symbol">`bb_w&#x27;</span> = <span class="hljs-symbol">`yy&#x27;</span>, <span class="hljs-symbol">`rr&#x27;</span>, <span class="hljs-symbol">`bb_w&#x27;</span><br>            <span class="hljs-keyword">matrix</span> <span class="hljs-symbol">`bb&#x27;</span>  = <span class="hljs-built_in">nullmat</span>(<span class="hljs-symbol">`bb&#x27;</span>) \ <span class="hljs-symbol">`bb_w&#x27;</span><br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">matrix</span> colnames <span class="hljs-symbol">`bb&#x27;</span> = <span class="hljs-string">&quot;timing&quot;</span> <span class="hljs-string">&quot;rel_date&quot;</span> <span class="hljs-symbol">`b_idc&#x27;</span><br><span class="hljs-keyword">matrix</span> ES_weights = <span class="hljs-symbol">`bb&#x27;</span><br><span class="hljs-keyword">mat</span> <span class="hljs-keyword">list</span> ES_weights<br>putexcel <span class="hljs-keyword">set</span> <span class="hljs-string">&quot;weightfiles&quot;</span>, <span class="hljs-keyword">replace</span> <br>putexcel A1=<span class="hljs-built_in">matrix</span>(ES_weights), colnames<br><br><span class="hljs-comment">*- 导入weightfiles.xlsx文件并画图</span><br>import excel <span class="hljs-string">&quot;weightfiles.xlsx&quot;</span>, <span class="hljs-keyword">clear</span> firstrow<br><span class="hljs-keyword">local</span> period <span class="hljs-string">&quot;relf_3&quot;</span><br><span class="hljs-keyword">keep</span> timing rel_date <span class="hljs-symbol">`period&#x27;</span><br><span class="hljs-keyword">reshape</span> wide <span class="hljs-symbol">`period&#x27;</span>, <span class="hljs-built_in">i</span>(rel_date) <span class="hljs-built_in">j</span>(timing) <br><br><span class="hljs-keyword">gr</span> bar <span class="hljs-symbol">`period&#x27;</span>5 <span class="hljs-symbol">`period&#x27;</span>10 <span class="hljs-symbol">`period&#x27;</span>15, over(rel_date) <span class="hljs-comment">///</span><br>    bar(1, color(gs0)) bar(2, color(gs6))  bar(3, color(gs12))  <span class="hljs-comment">///</span><br>    yline(0, lw(medium)) <span class="hljs-comment">///</span><br>    ytit(<span class="hljs-string">&quot;权重&quot;</span>) b1tit(<span class="hljs-string">&quot;相对处理时期&quot;</span>) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;组群1（T*=5）&quot;</span> 2 <span class="hljs-string">&quot;组群2（T*=10）&quot;</span> 3 <span class="hljs-string">&quot;组群3（T*=15）&quot;</span>) col(1) <span class="hljs-variable">$tllgd</span>)  ysize(3) scale(1.3)<br><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_SAweights.png&quot;</span>, width(3000) <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_SAweights.svg&quot;</span>, <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> <span class="hljs-keyword">save</span> figure/ES_SAweights.gph, <span class="hljs-keyword">replace</span><br><br><span class="hljs-comment">/*- 检查权重分解结果</span><br><span class="hljs-comment">1.使用S&amp;A提供的stata包进行权重分解和交叉检验</span><br><span class="hljs-comment">    use simu_data_DGP03.dta,clear</span><br><span class="hljs-comment">    local b_idc &quot;relf_3&quot; // 设定目标时期</span><br><span class="hljs-comment">    eventstudyweights relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 relf*, absorb(i.id i.time) cohort(timing) rel_time(rel_date) saveweights(&quot;weights&quot;) </span><br><span class="hljs-comment">    import excel &quot;weights.xlsx&quot;, clear firstrow</span><br><span class="hljs-comment">    keep `b_idc&#x27; timing rel_date</span><br><span class="hljs-comment">    reshape wide `b_idc&#x27;, i(rel_date) j(timing)</span><br><span class="hljs-comment">    egen w_sum = rowtotal(`b_idc&#x27;*)</span><br><span class="hljs-comment">    egen w_sumt = total(w_sum)</span><br><span class="hljs-comment">    egen w_g = total(w_sum) if rel_date==-2</span><br><span class="hljs-comment">    egen w_incl = total(w_sum) if inrange(rel_date,-14,-3) | rel_date&gt;=0</span><br><span class="hljs-comment">    egen w_excl = total(w_sum) if rel_date==-1</span><br><span class="hljs-comment">    egen w_pretrend = total(w_sum) if rel_date&gt;=0</span><br><span class="hljs-comment">    sum w_pretrend</span><br><span class="hljs-comment">    scalar w_c = r(mean)</span><br><span class="hljs-comment">    local w_c = round(w_c,0.001)</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">    gr bar `b_idc&#x27;5 `b_idc&#x27;10 `b_idc&#x27;15, over(rel_date) ///</span><br><span class="hljs-comment">        bar(1, color(gs0)) bar(2, color(gs6))  bar(3, color(gs12))  ///</span><br><span class="hljs-comment">        yline(0, lc(plr1) lw(medium)) ylab(, format(%5.1f)) ///</span><br><span class="hljs-comment">        ytit(&quot;权重&quot;) b1tit(&quot;相对处理时期&quot;) ///</span><br><span class="hljs-comment">        legend(order(1 &quot;组群1（T*=5）&quot; 2 &quot;组群2（T*=10）&quot; 3 &quot;组群3（T*=15）&quot;) col(1) $tllgd)  ysize(3) scale(1.3)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">2.手动检查第4期权重</span><br><span class="hljs-comment">    use simu_data_DGP03, clear</span><br><span class="hljs-comment">    gen c1_relf_4 = (timing==5)*(rel_date==4)</span><br><span class="hljs-comment">    gen c2_relf_4 = (timing==10)*(rel_date==4)</span><br><span class="hljs-comment">    gen c3_relf_4 = (timing==15)*(rel_date==4)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    cap drop *_b</span><br><span class="hljs-comment">    reghdfe c1_relf_4 relb_* relf_*,a(id time) nocons</span><br><span class="hljs-comment">    gen c1_relf_4_b = _b[relf_3]</span><br><span class="hljs-comment">    reghdfe c2_relf_4 relb_* relf_*,a(id time) nocons</span><br><span class="hljs-comment">    gen c2_relf_4_b = _b[relf_3]</span><br><span class="hljs-comment">    reghdfe c3_relf_4 relb_* relf_*,a(id time) nocons</span><br><span class="hljs-comment">    gen c3_relf_4_b = _b[relf_3]</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    gr bar (mean) c1_relf_4_b c2_relf_4_b c3_relf_4_b, bargap(100) blabel(bar, format(%6.4f)) ///</span><br><span class="hljs-comment">        legend(order(1 &quot;组群1&quot; 2 &quot;组群2&quot; 3 &quot;组群3&quot;)) ylabel(-0.1(0.05)0.1) ///</span><br><span class="hljs-comment">        title(&quot;各组群第4期ATT对&#123;&amp;beta&#125;&#123;sub:3&#125;的权重&quot;)</span><br><span class="hljs-comment">*/</span><br><br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       图11       **</span><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">* 异质性处理效应稳健估计量</span><br><span class="hljs-comment">*   - 组群-时间ATT估计量</span><br><span class="hljs-comment">*       - De Chaisemartin &amp; D’Haultfoeuille (2020)</span><br><span class="hljs-comment">*       - Sun &amp; Abraham (2021)</span><br><span class="hljs-comment">*       - Callaway &amp; Sant&#x27;Anna (2021)</span><br><span class="hljs-comment">*       - Dube et al.(2023)</span><br><span class="hljs-comment">*   - 插补法Imputation</span><br><span class="hljs-comment">*       - Borusyak et al.(2023)</span><br><span class="hljs-comment">*       - Gardner(2022)</span><br><span class="hljs-comment">*       - Liu et al.(2022)</span><br><span class="hljs-comment">*   - 堆叠法 Stacked DID</span><br><span class="hljs-comment">*       -Cengiz et al.(2019)</span><br><span class="hljs-keyword">use</span> simu_data_DGP03, <span class="hljs-keyword">clear</span><br><br><span class="hljs-comment">* true ATT_l</span><br><span class="hljs-keyword">matrix</span> btrue = <span class="hljs-built_in">J</span>(1,21,.)<br><span class="hljs-keyword">matrix</span> colnames btrue = relb10 relb9 relb8 relb7 relb6 relb5 relb4 relb3 relb2 relb1 relf0 relf1 relf2 relf3 relf4 relf5 relf6 relf7 relf8 relf9 relf10<br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">l</span> = 1/10 &#123;<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`l&#x27;</span>]=0<br>&#125;<br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">h</span> = 0/10 &#123;<br>    <span class="hljs-keyword">sum</span> tauit <span class="hljs-keyword">if</span> rel_date==<span class="hljs-symbol">`h&#x27;</span>&amp;<span class="hljs-keyword">D</span>==1<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`h&#x27;</span>+11]=<span class="hljs-built_in">r</span>(<span class="hljs-keyword">mean</span>)<br>&#125;<br><span class="hljs-keyword">matrix</span> <span class="hljs-keyword">list</span> btrue<br><br><span class="hljs-comment">* TWFE event study</span><br><span class="hljs-keyword">est</span> <span class="hljs-keyword">clear</span><br>reghdfe y relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 o.rel_base relf_*, a(id time) <span class="hljs-keyword">cluster</span>(id)<br>eststo TWFE<br><br><span class="hljs-comment">* Sun &amp; Abraham (2021)</span><br><span class="hljs-keyword">gen</span> never = treat==1<br>eventstudyinteract y relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 relf_* rel_base, <span class="hljs-keyword">vce</span>(<span class="hljs-keyword">cluster</span> id) absorb(id time) cohort(timing) control_cohort(never) <span class="hljs-comment">//使用的是eventstudytnteract这个包</span><br><span class="hljs-keyword">matrix</span> sa_b = <span class="hljs-built_in">e</span>(b_iw) <span class="hljs-comment">// storing the estimates for later</span><br><span class="hljs-keyword">matrix</span> sa_v = <span class="hljs-built_in">e</span>(V_iw)<br><br><span class="hljs-comment">* Callaway &amp; Sant&#x27;Anna (2021)</span><br><span class="hljs-keyword">gen</span> csind = timing<br><span class="hljs-keyword">replace</span> csind = 0 <span class="hljs-keyword">if</span> <span class="hljs-built_in">mi</span>(csind)<br>csdid y, ivar(id) time(time) gvar(csind) notyet agg(event) <span class="hljs-comment">//csdid</span><br>eststo csdid<br><br><span class="hljs-comment">* Dube et al.(2023) 局部投影DID</span><br><span class="hljs-keyword">xtset</span> id time<br><span class="hljs-keyword">cap</span> <span class="hljs-keyword">drop</span> t *_lpdid*<br><span class="hljs-keyword">gen</span> t = _n-15 <span class="hljs-keyword">if</span> _n&lt;=30<br><span class="hljs-keyword">gen</span> b_lpdid_fe = .<br><span class="hljs-keyword">gen</span> se_lpdid_fe = .<br><br><span class="hljs-keyword">forval</span> j =14(-1)2 &#123;<br>    <span class="hljs-keyword">qui</span>: reghdfe y relb_<span class="hljs-symbol">`j&#x27;</span> <span class="hljs-keyword">if</span> (rel_date==-<span class="hljs-symbol">`j&#x27;</span> | rel_base==1 &amp; treat!=1) | treat==1, a(id time) <span class="hljs-keyword">cluster</span>(id)    <br>    <span class="hljs-keyword">qui</span>: <span class="hljs-keyword">replace</span> b_lpdid_fe   =  _b[relb_<span class="hljs-symbol">`j&#x27;</span>]  <span class="hljs-keyword">if</span> t==-<span class="hljs-symbol">`j&#x27;</span><br>    <span class="hljs-keyword">qui</span>: <span class="hljs-keyword">replace</span> se_lpdid_fe  = _se[relb_<span class="hljs-symbol">`j&#x27;</span>]  <span class="hljs-keyword">if</span> t==-<span class="hljs-symbol">`j&#x27;</span><br>&#125;<br><br><span class="hljs-keyword">forval</span> j =0(1)15 &#123;<br>    <span class="hljs-keyword">qui</span>: reghdfe y relf_<span class="hljs-symbol">`j&#x27;</span> <span class="hljs-keyword">if</span> (rel_date==<span class="hljs-symbol">`j&#x27;</span> | rel_base==1 &amp; treat!=1) | treat==1, a(id time) <span class="hljs-keyword">cluster</span>(id) <br>    <span class="hljs-keyword">qui</span>: <span class="hljs-keyword">replace</span> b_lpdid_fe   = _b[relf_<span class="hljs-symbol">`j&#x27;</span>]  <span class="hljs-keyword">if</span> t==<span class="hljs-symbol">`j&#x27;</span><br>    <span class="hljs-keyword">qui</span>: <span class="hljs-keyword">replace</span> se_lpdid_fe  = _se[relf_<span class="hljs-symbol">`j&#x27;</span>]  <span class="hljs-keyword">if</span> t==<span class="hljs-symbol">`j&#x27;</span><br>&#125;<br><span class="hljs-keyword">replace</span>  b_lpdid_fe  = 0 <span class="hljs-keyword">if</span> t==-1<br><span class="hljs-keyword">replace</span> se_lpdid_fe  = 0 <span class="hljs-keyword">if</span> t==-1<br><span class="hljs-keyword">tostring</span> t, <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">replace</span> t = <span class="hljs-string">&quot;T&quot;</span> + t<br><span class="hljs-keyword">mkmat</span> b_lpdid_fe, <span class="hljs-keyword">mat</span>(lpdid_b) rownames(t) nomissing<br><span class="hljs-keyword">mkmat</span> se_lpdid_fe, <span class="hljs-keyword">mat</span>(lpdid_se) rownames(t) nomissing<br><br><span class="hljs-comment">* Borusyak et al.(2023) 插补法</span><br>did_imputation y id time timing, allhorizons  pretrend(10) <br>eststo bjs<br><br><span class="hljs-comment">* Gardner(2022)</span><br>did2s y, first_stage(i.id i.time) second_stage(relb* rel_base relf*) treatment(<span class="hljs-keyword">D</span>) <span class="hljs-keyword">cluster</span>(id)<br>eststo twostage<br><br><span class="hljs-comment">* Liu et al.(2022)</span><br>fect y, treat(<span class="hljs-keyword">D</span>) unit(id) time(time) method(<span class="hljs-string">&quot;fe&quot;</span>) <span class="hljs-keyword">se</span> nboots(30)<br><span class="hljs-keyword">matrix</span> fect_results = <span class="hljs-built_in">e</span>(ATTs)<br><span class="hljs-keyword">matrix</span> rownames fect_results = relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 relb_1 relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11<br><span class="hljs-keyword">matrix</span> fect_b = fect_results[4..24,3] <span class="hljs-comment">// storing the estimates for later</span><br><span class="hljs-keyword">matrix</span> fect_v = fect_results[4..24,4]<br><br><span class="hljs-comment">* Cengiz et al.(2019) 堆叠法</span><br>stackedev y relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 relf_* rel_base, cohort(timing) time(time) never_treat(never) unit_fe(id) clust_unit(id)<br>eststo <span class="hljs-keyword">stack</span><br><br><span class="hljs-comment">* 建议先用event_plot随便画一个图，否则可能报错(原因未知)</span><br>event_plot <span class="hljs-keyword">stack</span>, stub_lag(relf_#) stub_lead(relb_#) plottype(<span class="hljs-keyword">scatter</span>) ciplottype(rcap) <br><br><span class="hljs-comment">* 画图</span><br><span class="hljs-comment">* eventplot只支持8个估计结果</span><br><span class="hljs-comment">* 真实系数+TWFE+6个稳健估计量</span><br>event_plot btrue# TWFE sa_b#sa_v csdid lpdid_b#lpdid_se bjs twostage <span class="hljs-keyword">stack</span>, <span class="hljs-comment">///</span><br>    stub_lag(relf# relf_# relf_# Tp# T# tau# relf_# relf_#) <span class="hljs-comment">///</span><br>    stub_lead(relb# relb_# relb_# Tm# T-# pre# relb_# relb_#) <span class="hljs-comment">///</span><br>    plottype(<span class="hljs-keyword">scatter</span>) ciplottype(rspike) <span class="hljs-comment">///</span><br>    together perturb(-0.35(0.1)0.35) trimlead(10) trimlag(10) noautolegend <span class="hljs-comment">///</span><br>    graph_opt(xtit(<span class="hljs-string">&quot;相对处理发生时间&quot;</span>) ytitle(<span class="hljs-string">&quot;估计系数&quot;</span>) xlabel(-10(1)10) ylabel(-3(3)9) <span class="hljs-comment">///</span><br>        legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;真实系数&quot;</span> 2 <span class="hljs-string">&quot;事件研究法TWFE&quot;</span> 4 <span class="hljs-string">&quot;Sun &amp; Abraham（2021）&quot;</span>  <span class="hljs-comment">///</span><br>                     6 <span class="hljs-string">&quot;Callaway &amp; Sant&#x27;Anna（2021）&quot;</span> 8 <span class="hljs-string">&quot;Dube et al.（2023）&quot;</span> 10 <span class="hljs-string">&quot;Borusyak et al.（2022）&quot;</span> <span class="hljs-comment">///</span><br>                     12 <span class="hljs-string">&quot;Gardner（2022）&quot;</span> 14 <span class="hljs-string">&quot;Cengiz et al.（2019）&quot;</span>) col(2) <span class="hljs-variable">$tllgd</span>) <span class="hljs-comment">///</span><br>        xline(-0.5, lcolor(gs8) lp(dash)) yline(0, lcolor(gs0) lp(solid)) <span class="hljs-comment">///</span><br>        xsize(10) ysize(5) scale(1.3) <span class="hljs-comment">///</span><br>    ) <span class="hljs-comment">///</span><br>    lag_opt1(msymbol(Oh) color(plb1))         lag_ci_opt1(color(cranberry)) <span class="hljs-comment">///</span><br>    lag_opt2(msymbol(o)  color(plr1))         lag_ci_opt2(color(plr1)) <span class="hljs-comment">///</span><br>    lag_opt3(msymbol(<span class="hljs-keyword">d</span>)  color(navy))         lag_ci_opt3(color(navy)) <span class="hljs-comment">///</span><br>    lag_opt4(msymbol(t)  color(forest_green)) lag_ci_opt4(color(forest_green)) <span class="hljs-comment">///</span><br>    lag_opt5(msymbol(s)  color(dkorange))     lag_ci_opt5(color(dkorange)) <span class="hljs-comment">///</span><br>    lag_opt6(msymbol(th) color(purple))       lag_ci_opt6(color(purple)) <span class="hljs-comment">///</span><br>    lag_opt7(msymbol(dh) color(plb2))         lag_ci_opt7(color(plb2)) <span class="hljs-comment">///</span><br>    lag_opt8(msymbol(<span class="hljs-keyword">sh</span>) color(plr2))         lag_ci_opt8(color(plr2)) <br><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_HTest1.png&quot;</span>, width(3000) <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_HTest1.svg&quot;</span>, <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> <span class="hljs-keyword">save</span> figure/ES_HTest1.gph, <span class="hljs-keyword">replace</span><br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       图12       **</span><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">*** 使用未处理样本检验平行趋势</span><br><span class="hljs-keyword">use</span> simu_data_DGP03, <span class="hljs-keyword">clear</span><br><br><span class="hljs-comment">* true ATT_l</span><br><span class="hljs-keyword">matrix</span> btrue = <span class="hljs-built_in">J</span>(1,30,.)<br><span class="hljs-keyword">matrix</span> colnames btrue = <span class="hljs-variable">$leadall</span> <span class="hljs-variable">$lagall</span><br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">l</span> = 1/14 &#123;<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`l&#x27;</span>]=0<br>&#125;<br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">h</span> = 0/15 &#123;<br>    <span class="hljs-keyword">sum</span> tauit <span class="hljs-keyword">if</span> rel_date==<span class="hljs-symbol">`h&#x27;</span>&amp;<span class="hljs-keyword">D</span>==1<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`h&#x27;</span>+15]=<span class="hljs-built_in">r</span>(<span class="hljs-keyword">mean</span>)<br>&#125;<br><span class="hljs-keyword">matrix</span> <span class="hljs-keyword">list</span> btrue<br><br><span class="hljs-comment">* TWFE</span><br>reghdfe y relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 o.rel_base relf_*, a(id time) <span class="hljs-keyword">cluster</span>(id)<br>eststo TWFE<br><span class="hljs-keyword">testparm</span> <span class="hljs-variable">$leadall</span><br><br><span class="hljs-comment">* TWFE，使用未处理子样本</span><br>reghdfe y relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 o.rel_base <span class="hljs-keyword">if</span> <span class="hljs-keyword">D</span>==0, a(id time) <span class="hljs-keyword">cluster</span>(id)<br>eststo TWFE_pre<br><span class="hljs-keyword">testparm</span> <span class="hljs-variable">$leadall</span><br><br><br>coefplot (<span class="hljs-built_in">matrix</span>(btrue[1]), <span class="hljs-keyword">recast</span>(<span class="hljs-keyword">scatter</span>) msym(Oh) ) (TWFE, <span class="hljs-built_in">m</span>(s) ) (TWFE_pre, <span class="hljs-built_in">m</span>(t)) , <span class="hljs-keyword">keep</span>(<span class="hljs-variable">$leadall</span>) omitted baselevel vertical <span class="hljs-comment">///</span><br>    <span class="hljs-keyword">recast</span>(con) ciopts(<span class="hljs-keyword">recast</span>(rcap)) yline(0, lc(gs0) lp(solid)) <span class="hljs-comment">///</span><br>    xline(14, lc(gs8) lp(dash)) ylabel(-6(2)4) xtit(<span class="hljs-string">&quot;相对处理时期&quot;</span>) ytit(<span class="hljs-string">&quot;估计系数&quot;</span>) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(2 <span class="hljs-string">&quot;真实系数&quot;</span> 4 <span class="hljs-string">&quot;全样本&quot;</span> 6 <span class="hljs-string">&quot;未处理子样本&quot;</span>) <span class="hljs-variable">$blgd</span>) <span class="hljs-comment">///</span><br>    text(-5 1 <span class="hljs-string">&quot;全样本：F=12.78  p=0.00***&quot;</span>, size(medium) placement(<span class="hljs-keyword">e</span>)) <span class="hljs-comment">///</span><br>    text(2.5 1 <span class="hljs-string">&quot;子样本：F=0.78  p=0.69&quot;</span>, size(medium) placement(<span class="hljs-keyword">e</span>)) scale(1.2)<br><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_HTpretest.png&quot;</span>, width(3000) <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_HTpretest.svg&quot;</span>, <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> <span class="hljs-keyword">save</span> figure/ES_HTpretest.gph, <span class="hljs-keyword">replace</span><br></code></pre></td></tr></table></figure>

<h3 id="3-5-同时存在异质性处理效应与组群时间趋势的情况（估计不准确）"><a href="#3-5-同时存在异质性处理效应与组群时间趋势的情况（估计不准确）" class="headerlink" title="3.5 同时存在异质性处理效应与组群时间趋势的情况（估计不准确）"></a>3.5 同时存在异质性处理效应与组群时间趋势的情况（估计不准确）</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">clear</span> all<br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       图13       **</span><br><span class="hljs-comment">**********************</span><br><span class="hljs-keyword">use</span> simu_data_DGP04, <span class="hljs-keyword">clear</span><br><br><span class="hljs-keyword">preserve</span> <br><span class="hljs-keyword">collapse</span> (<span class="hljs-keyword">mean</span>) y y0 y1, <span class="hljs-keyword">by</span>(treat time rel_date)<br><span class="hljs-keyword">tw</span>  (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==2, color(plb1) lp(solid) lw(medthick) c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(O)) (<span class="hljs-keyword">line</span> y0 time <span class="hljs-keyword">if</span> treat==2&amp;rel_date&gt;=-1, lc(plb1) lp(dash) lw(thick)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==3, color(plr1) lp(solid) lw(medthick) c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(T)) (<span class="hljs-keyword">line</span> y0 time <span class="hljs-keyword">if</span> treat==3&amp;rel_date&gt;=-1, lc(plr1) lp(dash) lw(thick)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==4, color(plg1) lp(solid) lw(medthick) c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(S)) (<span class="hljs-keyword">line</span> y0 time <span class="hljs-keyword">if</span> treat==4&amp;rel_date&gt;=-1, lc(plg1) lp(dash) lw(thick)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> y time <span class="hljs-keyword">if</span> treat==1, color(ply1) lp(solid) lw(medthick) c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(<span class="hljs-keyword">D</span>)), <span class="hljs-comment">///</span><br>    ylabel(0(20)80) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;组群1（T*= 5）&quot;</span> 3 <span class="hljs-string">&quot;组群2（T*=10）&quot;</span> 5 <span class="hljs-string">&quot;组群3（T*=15）&quot;</span> 7 <span class="hljs-string">&quot;控制组&quot;</span> ) <span class="hljs-variable">$blgd</span> col(2)) xtitle(<span class="hljs-string">&quot;时期&quot;</span>) ytitle(<span class="hljs-string">&quot;结果变量Y&quot;</span>) scale(1.2)<br><span class="hljs-keyword">restore</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_HTNPdata.png&quot;</span>, width(3000) <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_HTNPdata.svg&quot;</span>, <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> <span class="hljs-keyword">save</span> figure/ES_HTNPdata.gph, <span class="hljs-keyword">replace</span><br><br><span class="hljs-keyword">preserve</span> <br><span class="hljs-keyword">collapse</span> (<span class="hljs-keyword">mean</span>) tauit, <span class="hljs-keyword">by</span>(treat rel_date)<br><span class="hljs-keyword">tw</span>  (<span class="hljs-keyword">sc</span> tauit rel_date <span class="hljs-keyword">if</span> treat==2, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(s)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> tauit rel_date <span class="hljs-keyword">if</span> treat==3, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(t)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">sc</span> tauit rel_date <span class="hljs-keyword">if</span> treat==4, c(<span class="hljs-keyword">l</span>) <span class="hljs-built_in">m</span>(<span class="hljs-keyword">d</span>)), xlabel(-15(5)15) <span class="hljs-comment">///</span><br>    xtitle(<span class="hljs-string">&quot;相对处理时期&quot;</span>) ytitle(<span class="hljs-string">&quot;平均处理效应 (ATT)&quot;</span>) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;组群1 (T*=  5, ATT&#123;sub:t&#125;=0.5t)&quot;</span> 2 <span class="hljs-string">&quot;组群2 (T*=10, ATT&#123;sub:t&#125;=1t)&quot;</span> 3 <span class="hljs-string">&quot;组群3 (T*=15, ATT&#123;sub:t&#125;=2t)&quot;</span>) <span class="hljs-variable">$tllgd</span> col(1)) <br><span class="hljs-keyword">restore</span><br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       图14       **</span><br><span class="hljs-comment">**********************</span><br><span class="hljs-keyword">use</span> simu_data_DGP04, <span class="hljs-keyword">clear</span><br><span class="hljs-keyword">est</span> <span class="hljs-keyword">clear</span><br><br><span class="hljs-comment">* true ATT</span><br><span class="hljs-keyword">matrix</span> btrue = <span class="hljs-built_in">J</span>(1,21,.)<br><span class="hljs-keyword">matrix</span> colnames btrue = relb10 relb9 relb8 relb7 relb6 relb5 relb4 relb3 relb2 relb1 relf0 relf1 relf2 relf3 relf4 relf5 relf6 relf7 relf8 relf9 relf10<br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">l</span> = 1/10 &#123;<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`l&#x27;</span>]=0<br>&#125;<br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">forvalues</span> <span class="hljs-keyword">h</span> = 0/10 &#123;<br>    <span class="hljs-keyword">sum</span> tauit <span class="hljs-keyword">if</span> rel_date==<span class="hljs-symbol">`h&#x27;</span>&amp;<span class="hljs-keyword">D</span>==1<br>    <span class="hljs-keyword">matrix</span> btrue[1,<span class="hljs-symbol">`h&#x27;</span>+11]=<span class="hljs-built_in">r</span>(<span class="hljs-keyword">mean</span>)<br>&#125;<br><span class="hljs-keyword">matrix</span> <span class="hljs-keyword">list</span> btrue<br><br><span class="hljs-comment">* TWFE event study</span><br>reghdfe y relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 o.rel_base relf_*, a(id time) <span class="hljs-keyword">cluster</span>(id)<br>eststo TWFE<br><br><span class="hljs-comment">* Sun &amp; Abraham (2021)</span><br><span class="hljs-keyword">gen</span> never = treat==1<br>eventstudyinteract y relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 relf_* rel_base, <span class="hljs-keyword">vce</span>(<span class="hljs-keyword">cluster</span> id) absorb(id time) cohort(timing) control_cohort(never)<br><span class="hljs-keyword">matrix</span> sa_b = <span class="hljs-built_in">e</span>(b_iw) <span class="hljs-comment">// storing the estimates for later</span><br><span class="hljs-keyword">matrix</span> sa_v = <span class="hljs-built_in">e</span>(V_iw)<br><br><span class="hljs-comment">* Callaway &amp; Sant&#x27;Anna (2021)</span><br><span class="hljs-keyword">gen</span> csind = timing<br><span class="hljs-keyword">replace</span> csind = 0 <span class="hljs-keyword">if</span> <span class="hljs-built_in">mi</span>(csind)<br>csdid y, ivar(id) time(time) gvar(csind) notyet agg(event)<br>eststo csdid<br><br><span class="hljs-comment">* Dube et al.(2023)</span><br><span class="hljs-keyword">xtset</span> id time<br><span class="hljs-keyword">cap</span> <span class="hljs-keyword">drop</span> t *_lpdid*<br><span class="hljs-keyword">gen</span> t = _n-15 <span class="hljs-keyword">if</span> _n&lt;=30<br><span class="hljs-keyword">gen</span> b_lpdid_fe = .<br><span class="hljs-keyword">gen</span> se_lpdid_fe = .<br><br><span class="hljs-keyword">forval</span> j =14(-1)2 &#123;<br>    <span class="hljs-keyword">qui</span>: reghdfe y relb_<span class="hljs-symbol">`j&#x27;</span> <span class="hljs-keyword">if</span> (rel_date==-<span class="hljs-symbol">`j&#x27;</span> | rel_base==1 &amp; treat!=1) | treat==1, a(id time) <span class="hljs-keyword">cluster</span>(id)    <br>    <span class="hljs-keyword">replace</span> b_lpdid_fe   =  _b[relb_<span class="hljs-symbol">`j&#x27;</span>]  <span class="hljs-keyword">if</span> t==-<span class="hljs-symbol">`j&#x27;</span><br>    <span class="hljs-keyword">replace</span> se_lpdid_fe  = _se[relb_<span class="hljs-symbol">`j&#x27;</span>]  <span class="hljs-keyword">if</span> t==-<span class="hljs-symbol">`j&#x27;</span><br>&#125;<br><br><span class="hljs-keyword">forval</span> j =0(1)15 &#123;<br>    <span class="hljs-keyword">qui</span>: reghdfe y relf_<span class="hljs-symbol">`j&#x27;</span> <span class="hljs-keyword">if</span> (rel_date==<span class="hljs-symbol">`j&#x27;</span> | rel_base==1 &amp; treat!=1) | treat==1, a(id time) <span class="hljs-keyword">cluster</span>(id) <br>    <span class="hljs-keyword">replace</span> b_lpdid_fe   = _b[relf_<span class="hljs-symbol">`j&#x27;</span>]  <span class="hljs-keyword">if</span> t==<span class="hljs-symbol">`j&#x27;</span><br>    <span class="hljs-keyword">replace</span> se_lpdid_fe  = _se[relf_<span class="hljs-symbol">`j&#x27;</span>]  <span class="hljs-keyword">if</span> t==<span class="hljs-symbol">`j&#x27;</span><br>&#125;<br><span class="hljs-keyword">replace</span>  b_lpdid_fe  = 0 <span class="hljs-keyword">if</span> t==-1<br><span class="hljs-keyword">replace</span> se_lpdid_fe  = 0 <span class="hljs-keyword">if</span> t==-1<br><span class="hljs-keyword">tostring</span> t, <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">replace</span> t = <span class="hljs-string">&quot;T&quot;</span> + t<br><span class="hljs-keyword">mkmat</span> b_lpdid_fe, <span class="hljs-keyword">mat</span>(lpdid_b) rownames(t) nomissing<br><span class="hljs-keyword">mkmat</span> se_lpdid_fe, <span class="hljs-keyword">mat</span>(lpdid_se) rownames(t) nomissing<br><br><span class="hljs-comment">* Borusyak et al.(2023)</span><br>did_imputation y id time timing, allhorizons  pretrend(10) <br>eststo bjs<br><br><span class="hljs-comment">* Gardner(2022)</span><br>did2s y, first_stage(i.id i.time) second_stage(relb* rel_base relf*) treatment(<span class="hljs-keyword">D</span>) <span class="hljs-keyword">cluster</span>(id)<br>eststo twostage<br><br><span class="hljs-comment">* Liu et al.(2022)</span><br>fect y, treat(<span class="hljs-keyword">D</span>) unit(id) time(time) method(<span class="hljs-string">&quot;fe&quot;</span>) <span class="hljs-keyword">se</span> nboots(30)<br><span class="hljs-keyword">matrix</span> fect_results = <span class="hljs-built_in">e</span>(ATTs)<br><span class="hljs-keyword">matrix</span> rownames fect_results = relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 relb_1 relf_0 relf_1 relf_2 relf_3 relf_4 relf_5 relf_6 relf_7 relf_8 relf_9 relf_10 relf_11<br><span class="hljs-keyword">matrix</span> fect_b = fect_results[4..24,3] <span class="hljs-comment">// storing the estimates for later</span><br><span class="hljs-keyword">matrix</span> fect_v = fect_results[4..24,4]<br><br><span class="hljs-comment">* Cengiz et al.(2019)</span><br>stackedev y relb_14 relb_13 relb_12 relb_11 relb_10 relb_9 relb_8 relb_7 relb_6 relb_5 relb_4 relb_3 relb_2 relf_* rel_base, cohort(timing) time(time) never_treat(never) unit_fe(id) clust_unit(id)<br>eststo <span class="hljs-keyword">stack</span><br><br>event_plot <span class="hljs-keyword">stack</span>, stub_lag(relf_#) stub_lead(relb_#) plottype(<span class="hljs-keyword">scatter</span>) ciplottype(rcap) <br><br>event_plot btrue# TWFE sa_b#sa_v csdid lpdid_b#lpdid_se bjs twostage <span class="hljs-keyword">stack</span>, <span class="hljs-comment">///</span><br>    stub_lag(relf# relf_# relf_# Tp# T# tau# relf_# relf_#) <span class="hljs-comment">///</span><br>    stub_lead(relb# relb_# relb_# Tm# T-# pre# relb_# relb_#) <span class="hljs-comment">///</span><br>    plottype(<span class="hljs-keyword">scatter</span>) ciplottype(rspike) <span class="hljs-comment">///</span><br>    together perturb(-0.35(0.1)0.35) trimlead(10) trimlag(10) noautolegend <span class="hljs-comment">///</span><br>    graph_opt(xtit(<span class="hljs-string">&quot;相对处理时期&quot;</span>) ytitle(<span class="hljs-string">&quot;估计系数&quot;</span>) xlabel(-10(1)10) ylabel(-5(5)15) <span class="hljs-comment">///</span><br>        legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;真实系数&quot;</span> 2 <span class="hljs-string">&quot;事件研究法TWFE&quot;</span> 4 <span class="hljs-string">&quot;Sun &amp; Abraham（2021）&quot;</span>  6 <span class="hljs-string">&quot;Callaway &amp; Sant&#x27;Anna（2021）&quot;</span> 8 <span class="hljs-string">&quot;Dube et al.（2023）&quot;</span> 10 <span class="hljs-string">&quot;Borusyak et al.（2022）&quot;</span> <span class="hljs-comment">///</span><br>         12 <span class="hljs-string">&quot;Gardner（2022）&quot;</span> 14 <span class="hljs-string">&quot;Cengiz et al.（2019）&quot;</span>) col(2) <span class="hljs-variable">$tllgd</span> ) <span class="hljs-comment">///</span><br>        xline(-0.5, lcolor(gs8) lp(dash)) yline(0, lcolor(gs0) lp(solid)) <span class="hljs-comment">///</span><br>        xsize(10) ysize(5) scale(1.3) <span class="hljs-comment">///</span><br>    ) <span class="hljs-comment">///</span><br>    lag_opt1(msymbol(Oh) color(plb1)) lag_ci_opt1(color(cranberry)) <span class="hljs-comment">///</span><br>    lag_opt2(msymbol(o) color(plr1)) lag_ci_opt2(color(plr1)) <span class="hljs-comment">///</span><br>    lag_opt3(msymbol(<span class="hljs-keyword">d</span>) color(navy)) lag_ci_opt3(color(navy)) <span class="hljs-comment">///</span><br>    lag_opt4(msymbol(t) color(forest_green)) lag_ci_opt4(color(forest_green)) <span class="hljs-comment">///</span><br>    lag_opt5(msymbol(s) color(dkorange)) lag_ci_opt5(color(dkorange)) <span class="hljs-comment">///</span><br>    lag_opt6(msymbol(th) color(purple)) lag_ci_opt6(color(purple)) <span class="hljs-comment">///</span><br>    lag_opt7(msymbol(dh)  color(plb2)) lag_ci_opt7(color(plb2)) <span class="hljs-comment">///</span><br>    lag_opt8(msymbol(<span class="hljs-keyword">sh</span>)  color(plr2)) lag_ci_opt8(color(plr2)) <br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_HTNPest.png&quot;</span>, width(3000) <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_HTNPest.svg&quot;</span>, <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> <span class="hljs-keyword">save</span> figure/ES_HTNPest.gph, <span class="hljs-keyword">replace</span><br></code></pre></td></tr></table></figure>

<h3 id="3-6-原文图1和图4"><a href="#3-6-原文图1和图4" class="headerlink" title="3.6 原文图1和图4"></a>3.6 原文图1和图4</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-comment">* 设定主路径</span><br><span class="hljs-keyword">cd</span> <span class="hljs-string">&quot;$root&quot;</span><br><br><span class="hljs-keyword">clear</span> all<br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       图1        **</span><br><span class="hljs-comment">**********************</span><br><span class="hljs-keyword">use</span> Currie_2020, <span class="hljs-keyword">clear</span><br><span class="hljs-keyword">tw</span> (<span class="hljs-keyword">line</span> DD year, lw(thick)) (<span class="hljs-keyword">line</span> ES year, lw(thick)), <span class="hljs-comment">///</span><br>    xlab(2005(5)2020) ylab(0(0.05)0.25, <span class="hljs-keyword">format</span>(%6.2f)) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;双重差分法&quot;</span> 2 <span class="hljs-string">&quot;事件研究法&quot;</span>)) <span class="hljs-comment">///</span><br>    xtitle(<span class="hljs-string">&quot;&quot;</span>) ytitle(<span class="hljs-string">&quot;占比&quot;</span>) subtitle(<span class="hljs-string">&quot;（a）英文经济学五大刊&quot;</span>, pos(6)) scale(1.2) name(top5)<br><br><span class="hljs-keyword">use</span> cntop, <span class="hljs-keyword">clear</span><br><span class="hljs-keyword">keep</span> <span class="hljs-keyword">if</span> year&gt;=2004<br><span class="hljs-keyword">gen</span> DD_share = dd/<span class="hljs-keyword">total</span><br><span class="hljs-keyword">gen</span> ES_share = es/<span class="hljs-keyword">total</span><br><span class="hljs-keyword">gen</span> ESPT_share = espt/<span class="hljs-keyword">total</span><br><span class="hljs-keyword">two</span> (<span class="hljs-keyword">line</span> DD_share year, lw(thick)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">line</span> ES_share year, lw(thick)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">line</span> ESPT_share year, lw(thick) lp(shortdash)), <span class="hljs-comment">///</span><br>    xlab(2005(5)2020) ylab(0(0.05)0.25, <span class="hljs-keyword">format</span>(%6.2f)) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;双重差分法&quot;</span> 2 <span class="hljs-string">&quot;事件研究法&quot;</span> 3 <span class="hljs-string">&quot;事件研究法+平行趋势&quot;</span>) size(medsmall)) <span class="hljs-comment">///</span><br>    xtitle(<span class="hljs-string">&quot;&quot;</span>) ytitle(<span class="hljs-string">&quot;占比&quot;</span>) subtitle(<span class="hljs-string">&quot;（b）中文权威期刊&quot;</span>, pos(6)) scale(1.2) name(cntop)<br><br>grc1leg2 top5 cntop, ytol legendfrom(cntop) xsize(8) scale(1.5)<br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/topshare.png&quot;</span>, width(3000) <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/topshare.svg&quot;</span>,  <span class="hljs-keyword">replace</span><br><br><br><span class="hljs-comment">**********************</span><br><span class="hljs-comment">**       图4        **</span><br><span class="hljs-comment">**********************</span><br><br><span class="hljs-keyword">set</span> seed 20230101<br><span class="hljs-keyword">clear</span> all    <br><span class="hljs-keyword">set</span> obs 400<br><span class="hljs-keyword">gen</span> id = _n<br><span class="hljs-keyword">expand</span> 20<br><span class="hljs-keyword">bysort</span> id: <span class="hljs-keyword">gen</span> time = _n  <br><br><span class="hljs-comment">* 生成个体固定效应</span><br><span class="hljs-keyword">gen</span>  unit_c     = runiform(0,10) <span class="hljs-keyword">if</span> time==1<br><span class="hljs-keyword">egen</span> unit_fe  = <span class="hljs-keyword">mean</span>(unit_c), <span class="hljs-keyword">by</span>(id)<br><br><span class="hljs-keyword">gen</span>     indicator_c = unit_c <br><span class="hljs-keyword">qui</span> <span class="hljs-keyword">sum</span> indicator_c,<span class="hljs-keyword">d</span><br><span class="hljs-keyword">scalar</span>  threshold1   = <span class="hljs-built_in">r</span>(p25)<br><span class="hljs-keyword">scalar</span>  threshold2   = <span class="hljs-built_in">r</span>(p50)<br><span class="hljs-keyword">scalar</span>  threshold3   = <span class="hljs-built_in">r</span>(p75)<br><span class="hljs-keyword">egen</span>    indicator   = <span class="hljs-keyword">mean</span>(indicator_c), <span class="hljs-keyword">by</span>(id)<br><span class="hljs-keyword">gen</span>     treat = 1<br><span class="hljs-keyword">replace</span> treat = 2 <span class="hljs-keyword">if</span> indicator&gt;threshold1<br><span class="hljs-keyword">replace</span> treat = 3 <span class="hljs-keyword">if</span> indicator&gt;threshold2<br><span class="hljs-keyword">replace</span> treat = 4 <span class="hljs-keyword">if</span> indicator&gt;threshold3<br><span class="hljs-keyword">tab</span> treat, <span class="hljs-keyword">gen</span>(group)<br><br><span class="hljs-keyword">gen</span> timing = .<br><span class="hljs-keyword">replace</span> timing = 5 <span class="hljs-keyword">if</span> treat==2<br><span class="hljs-keyword">replace</span> timing = 10 <span class="hljs-keyword">if</span> treat==3<br><span class="hljs-keyword">replace</span> timing = 15 <span class="hljs-keyword">if</span> treat==4<br><br><span class="hljs-comment">* 定义潜在结果y0和y1</span><br><span class="hljs-keyword">gen</span> rel_date = time-timing<br><span class="hljs-keyword">replace</span> rel_date = 0 <span class="hljs-keyword">if</span> <span class="hljs-built_in">mi</span>(rel_date)<br><span class="hljs-keyword">gen</span> <span class="hljs-keyword">post</span> = rel_date&gt;=0<br><span class="hljs-keyword">gen</span> group_level = 15*group2 + 10*group3 +5*group4<br><span class="hljs-keyword">gen</span> group_trend = 0<br><span class="hljs-keyword">egen</span> X_cf = <span class="hljs-keyword">mean</span>(unit_c), <span class="hljs-keyword">by</span>(treat)<br><br><span class="hljs-keyword">gen</span> y0 = group_level + group_trend   + runiform(0,10)<br><span class="hljs-keyword">gen</span> y11 = group_level + group_trend   + (5*group2 + 5*group3 + 5*group4)*<span class="hljs-keyword">post</span> + runiform(0,10) <span class="hljs-comment">// static effect</span><br><span class="hljs-keyword">gen</span> y12 = group_level + group_trend   + (1*group2 + 1*group3 + 1*group4)*<span class="hljs-keyword">post</span>*(rel_date+1) + runiform(0,10) <span class="hljs-comment">// dynamic effect</span><br><span class="hljs-keyword">gen</span> y13 = group_level + group_trend   + (0.5*group2 + 1*group3 + 2*group4)*<span class="hljs-keyword">post</span>*(rel_date+1) + runiform(0,10) <span class="hljs-comment">// dynamic effect</span><br><br><span class="hljs-comment">* 生成观测样本y </span><br><span class="hljs-keyword">cap</span> <span class="hljs-keyword">drop</span> y<br><span class="hljs-keyword">gen</span> <span class="hljs-keyword">D</span> = 0<br><span class="hljs-keyword">replace</span> <span class="hljs-keyword">D</span> = 1 <span class="hljs-keyword">if</span> rel_date&gt;=0&amp;<span class="hljs-built_in">inlist</span>(treat,2,3,4)<br><span class="hljs-keyword">gen</span> y1 = (1-<span class="hljs-keyword">D</span>)*y0 + <span class="hljs-keyword">D</span>*y11<br><span class="hljs-keyword">gen</span> y2 = (1-<span class="hljs-keyword">D</span>)*y0 + <span class="hljs-keyword">D</span>*y12<br><span class="hljs-keyword">gen</span> y3 = (1-<span class="hljs-keyword">D</span>)*y0 + <span class="hljs-keyword">D</span>*y13<br><br><span class="hljs-keyword">preserve</span> <br><span class="hljs-keyword">collapse</span> (<span class="hljs-keyword">mean</span>)  y1 y2 y3 y0, <span class="hljs-keyword">by</span>(treat time)<br><span class="hljs-keyword">tw</span>  (<span class="hljs-keyword">line</span> y1 time <span class="hljs-keyword">if</span> treat==2, lw(thick)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">line</span> y1 time <span class="hljs-keyword">if</span> treat==3, lw(thick)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">line</span> y1 time <span class="hljs-keyword">if</span> treat==4, lw(thick)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">line</span> y1 time <span class="hljs-keyword">if</span> treat==1, lw(thick)), ylabel(0(10)30) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;组群1（ATT&#123;sub:t&#125;=5）&quot;</span> 2 <span class="hljs-string">&quot;组群2（ATT&#123;sub:t&#125;=5）&quot;</span> 3 <span class="hljs-string">&quot;组群3（ATT&#123;sub:t&#125;=5）&quot;</span> 4 <span class="hljs-string">&quot;控制组&quot;</span>) <span class="hljs-variable">$blgd</span> col(2)) xtitle(<span class="hljs-string">&quot;&quot;</span>) ytitle(<span class="hljs-string">&quot;结果变量Y&quot;</span>)  <span class="hljs-comment">///</span><br>    tit(<span class="hljs-string">&quot;（a）同质性处理效应&quot;</span>, pos(6)) name(TEA1)<br><span class="hljs-keyword">restore</span><br><br><span class="hljs-keyword">preserve</span> <br><span class="hljs-keyword">collapse</span> (<span class="hljs-keyword">mean</span>)  y1 y2 y3 y0, <span class="hljs-keyword">by</span>(treat time)<br><span class="hljs-keyword">tw</span>  (<span class="hljs-keyword">line</span> y2 time <span class="hljs-keyword">if</span> treat==2, lw(thick)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">line</span> y2 time <span class="hljs-keyword">if</span> treat==3, lw(thick)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">line</span> y2 time <span class="hljs-keyword">if</span> treat==4, lw(thick)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">line</span> y2 time <span class="hljs-keyword">if</span> treat==1, lw(thick)), ylabel(0(10)30) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;组群1（ATT&#123;sub:t&#125;=1t）&quot;</span> 2 <span class="hljs-string">&quot;组群2（ATT&#123;sub:t&#125;=1t）&quot;</span> 3 <span class="hljs-string">&quot;组群3（ATT&#123;sub:t&#125;=1t）&quot;</span> 4 <span class="hljs-string">&quot;控制组&quot;</span>) <span class="hljs-variable">$blgd</span> col(2)) xtitle(<span class="hljs-string">&quot;&quot;</span>) ytitle(<span class="hljs-string">&quot;结果变量Y&quot;</span>)   <span class="hljs-comment">///</span><br>    tit(<span class="hljs-string">&quot;（b）同质性处理效应路径&quot;</span>, pos(6)) name(TEA2)<br><span class="hljs-keyword">restore</span><br><br><span class="hljs-keyword">preserve</span> <br><span class="hljs-keyword">collapse</span> (<span class="hljs-keyword">mean</span>)  y1 y2 y3 y0, <span class="hljs-keyword">by</span>(treat time)<br><span class="hljs-keyword">tw</span>  (<span class="hljs-keyword">line</span> y3 time <span class="hljs-keyword">if</span> treat==2, lw(thick)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">line</span> y3 time <span class="hljs-keyword">if</span> treat==3, lw(thick)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">line</span> y3 time <span class="hljs-keyword">if</span> treat==4, lw(thick)) <span class="hljs-comment">///</span><br>    (<span class="hljs-keyword">line</span> y3 time <span class="hljs-keyword">if</span> treat==1, lw(thick)), ylabel(0(10)30) <span class="hljs-comment">///</span><br>    legend(<span class="hljs-keyword">order</span>(1 <span class="hljs-string">&quot;组群1（ATT&#123;sub:t&#125;=0.5t）&quot;</span> 2 <span class="hljs-string">&quot;组群2（ATT&#123;sub:t&#125;=1t）&quot;</span> 3 <span class="hljs-string">&quot;组群3（ATT&#123;sub:t&#125;=2t）&quot;</span> 4 <span class="hljs-string">&quot;控制组&quot;</span>) <span class="hljs-variable">$blgd</span> col(2)) xtitle(<span class="hljs-string">&quot;&quot;</span>) ytitle(<span class="hljs-string">&quot;结果变量Y&quot;</span>) <span class="hljs-comment">///</span><br>    tit(<span class="hljs-string">&quot;（c）异质性处理效应&quot;</span>, pos(6)) name(TEA3)<br><span class="hljs-keyword">restore</span><br><br><span class="hljs-keyword">gr</span> combine TEA1 TEA2 TEA3, ysize(4) xsize(12) row(1) scale(1.5)<br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_TEA.png&quot;</span>, width(3000) <span class="hljs-keyword">replace</span><br><span class="hljs-keyword">gr</span> export <span class="hljs-string">&quot;figure/ES_TEA.svg&quot;</span>, <span class="hljs-keyword">replace</span><br></code></pre></td></tr></table></figure>




                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%9B%A0%E6%9E%9C%E6%8E%A8%E6%96%AD/" class="print-no-link">#因果推断</a>
      
        <a href="/tags/DID/" class="print-no-link">#DID</a>
      
        <a href="/tags/%E4%BA%8B%E4%BB%B6%E7%A0%94%E7%A9%B6/" class="print-no-link">#事件研究</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Handbook of Event Study</div>
      <div>https://yuzhang.net/2023/11/11/Handbook of Event Study/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Yu Zhang</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年11月11日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/11/16/EXIOBASE%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D/" title="EXIOBASE结构介绍">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">EXIOBASE结构介绍</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/11/07/%E5%A6%82%E4%BD%95%E5%9C%A8hexo%E5%8D%9A%E5%AE%A2%E4%B8%AD%E5%B5%8C%E5%85%A5PDF/" title="如何在hexo博客中嵌入PDF">
                        <span class="hidden-mobile">如何在hexo博客中嵌入PDF</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
